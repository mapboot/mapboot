var mapboot=(()=>{var Wt=Object.defineProperty;var Wo=Object.getOwnPropertyDescriptor;var Uo=Object.getOwnPropertyNames;var Ho=Object.prototype.hasOwnProperty;var N=(t,e)=>()=>(t&&(e=t(t=0)),e);var hn=(t,e)=>{for(var n in e)Wt(t,n,{get:e[n],enumerable:!0})},Vo=(t,e,n,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Uo(e))!Ho.call(t,i)&&i!==n&&Wt(t,i,{get:()=>e[i],enumerable:!(o=Wo(e,i))||o.enumerable});return t};var Yo=t=>Vo(Wt({},"__esModule",{value:!0}),t);async function In({mapid:t,onSuccess:e,onError:n}){try{let o=await fetch(`/Builder/GetMap?mapid=${encodeURIComponent(t)}`);if(!o.ok)throw new Error(`Load failed: ${o.status} ${o.statusText}`);let i=await o.json();console.log("map fetched!",i),e?.(i)}catch(o){n?.(o)}}async function xn({map:t,onSuccess:e,onError:n}){try{let o=await fetch(`/Builder/PostMap?mapid=${encodeURIComponent(t.id)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok)throw new Error(`Save failed: ${o.status} ${o.statusText}`);let i;try{i=await o.json()}catch{i=t}console.log("map saved, server returned:",i),e?.(i)}catch(o){n?.(o)}}async function bn({mapid:t,onSuccess:e,onError:n}){try{let o=await fetch(`/Builder/PublishMap?mapid=${encodeURIComponent(t)}`,{method:"POST"});if(!o.ok)throw new Error(`Publish failed: ${o.status} ${o.statusText}`);let i;try{i=await o.json()}catch{i=null}console.log("map published, server returned:",i),e?.(i),console.log("map published, server returned:",i),e?.(i)}catch(o){n?.(o)}}var Ut=N(()=>{});var Et,vt,St,wt,Pt,Ht,qe,dt,bt,Me,pt,Re,de,Ce=N(()=>{Et="#EAEAEA",vt="#DDE1E2",St="#C9CED2",wt="#C1C3C7",Pt="#586974",Ht=Object.freeze({REGULAR:"regular",TRANSIT:"transit"}),qe=Object.freeze({FLOOR:"floor",PUBLIC:"public",PRIVATE:"private",INNERWALL:"innerwall",OUTERWALL:"outerwall",NONE:"none"}),dt=[qe.FLOOR,qe.PUBLIC,qe.PRIVATE,qe.INNERWALL,qe.OUTERWALL,qe.NONE],bt=class{constructor(e,n,o){this.id=e,this.color=n,this.lineThickness=o,this.enabled=!0}},Me=Object.freeze({Custom:"Custom",Exit:"Exit",Information:"Information",Restroom:"Restroom",FamilyRestroom:"Family Restroom",MaleRestroom:"Male Restroom",FemaleRestroom:"Female Restroom",Parking:"Parking",AccessibleRamp:"Accessible Ramp",ATM:"ATM",FirstAid:"FirstAid",Security:"Security",FireExtinguisher:"Fire Extinguisher",EmergencyExit:"Emergency Exit",LostAndFound:"Lost And Found",WaitingArea:"Waiting Area",ChargingStation:"Charging Station",VendingMachine:"Vending Machine",FoodService:"Food Service",Cafeteria:"Cafeteria",WaterFountain:"Water Fountain",SmokingArea:"Smoking Area",Playground:"Playground",GreenSpace:"Green Space",Kiosk:"Kiosk",Current_Kiosk:"Current Kiosk",FoodService:"Food Service",Taxi:"Taxi",Bus:"Bus",RideShare:"RideShare",Stairs:"Stairs",Escalator:"Escalator",Elevator:"Elevator",ServiceElevator:"Service Elevator",CrateElevator:"CrateE levator",FreightElevator:"Freigh tElevator",TrashCompactor:"Trash Compactor",TrashOpenBox:"Trash Open Box"}),pt=Object.freeze({Meters:"m",Feet:"feet"}),Re=Object.freeze({None:"None",Icon:"Icon",Label:"Label"}),de=class{constructor(e={}){this.x=e.x??e.X??0,this.y=e.y??e.Y??0,this.z=e.z??e.Z??0}}});function K(){let t=crypto.getRandomValues(new Uint8Array(4));return Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join("")}var Yt,qt,z,ve,Q,Ke,Xe,ut,Vt,gt,Be,ne=N(()=>{G();Ce();Yt="rgb(117, 206, 146)",qt="rgb(219, 118, 118)",z=Object.freeze({POINT:"point",LINE:"line",POLYGON:"polygon"}),ve=class{constructor(e={}){e&&typeof e=="object"&&"position"in e?(this.position=new de(e.position),this.groupId=e.groupId,this.layerId=e.layerId,this.locationId=e.locationId,e.twins&&(this.twins=[...e.twins])):(this.position=new de,this.groupId="",this.layerId="")}toJSON(){return{position:this.position,groupId:this.groupId,layerId:this.layerId,locationId:this.locationId,twins:this.twins}}},Q=class{constructor(e={}){e&&typeof e=="object"&&("pointIds"in e||"styleId"in e)?(this.styleId=e.styleId??"none",this.pointIds=[...e.pointIds??[]]):(this.styleId="none",this.pointIds=[])}toJSON(){return{styleId:this.styleId,pointIds:this.pointIds}}},Ke=class{constructor(e={}){if(typeof e=="object"&&(e.styles||typeof e.name=="string")){let n=e;this.name=n.name,this.enabled=n.enabled!==!1,this.backgroundOpacity=n.backgroundOpacity??1,this.backgroundDataURI=n.backgroundDataURI||"",this.backgroundWorldWidth=n.backgroundWorldWidth??100,this.backgroundWorldHeight=n.backgroundWorldHeight??100,this.locationIds=[...e.locationIds],this.polygons={},n.polygons&&typeof n.polygons=="object"&&Object.entries(n.polygons).forEach(([o,i])=>{this.polygons[o]=new Be(i)}),this.lines={},n&&typeof n.lines=="object"&&!Array.isArray(n.lines)&&(this.lines=Object.entries(n.lines).reduce((o,[i,s])=>{let r=new Q(s);return o[i]=r,o},{})),this.lineLayers={},this.polygonsByStyle={}}else this.name="layer",this.enabled=!0,this.backgroundOpacity=1,this.backgroundDataURI="",this.backgroundWorldWidth=100,this.backgroundWorldHeight=100,this.polygons={},this.lines={},this.locationIds=[],this.lineLayers={},this.polygonsByStyle={}}toJSON(){return{name:this.name,enabled:this.enabled,opacity:this.opacity,lines:this.lines,polygons:Object.fromEntries(Object.entries(this.polygons).map(([e,n])=>[e,n.toJSON?.()||n])),locationIds:this.locationIds}}},Xe=class{constructor(e={}){if(this.name=e.name||"",this.meta=e.meta||"",this.type=e.type||Ht.REGULAR,this.enabled=e.enabled||!0,e&&typeof e.layers=="object"&&!Array.isArray(e.layers))this.layers=Object.entries(e.layers).reduce((n,[o,i])=>{let s=new Ke(i);return n[o]=s,n},{});else{this.name="Group",this.type=Ht.REGULAR,this.layers={};let n=new Ke({}),o=K();this.layers[o]=n}}},ut=class{constructor(e={}){if(this.id=e.id||K(),this.name=e.name||"My Map",this.meta=e.meta||"",this.owner=e.owner||"",this.settings=e.settings||new Vt,this.groups={},e&&typeof e.groups=="object"&&!Array.isArray(e.groups))this.groups=Object.entries(e.groups).reduce((o,[i,s])=>{let r=new Xe(s);return o[i]=r,o},{});else{let o=K();this.groups[o]=new Xe}this.points={},e.points&&typeof e.points=="object"&&!Array.isArray(e.points)&&Object.entries(e.points).forEach(([o,i])=>{this.points[o]=new ve(i)}),this.locations={},e.locations&&typeof e.locations=="object"&&!Array.isArray(e.locations)&&Object.entries(e.locations).forEach(([o,i])=>{this.locations[o]=new gt(i)}),this.styles={},[["none",null,0],["floor",Et,0],["public",vt,0],["private",St,0],["innerwall",wt,3],["outerwall",Pt,4]].forEach(([o,i,s])=>{let r=new bt(o,i,s);r.enabled=!0,this.styles[o]=r})}toJSON(){return{id:this.id,name:this.name,meta:this.meta,groups:this.groups,points:this.points,locations:this.locations,settings:this.settings}}},Vt=class{constructor(e={}){this.unit=e.unit??pt.Meters,this.gridSize=e.gridSize??1,this.rotationSnap=e.rotationSnap??5,this.selectionRadius=e.selectionRadius??15,this.allowedDomains=e.allowedDomains||[]}toJSON(){return{unit:this.unit,gridSize:this.gridSize,rotationSnap:this.rotationSnap,selectionRadius:this.selectionRadius,allowedDomains:this.allowedDomains}}},gt=class{constructor(e={}){e?(this.name=e.name??"",this.meta=e.meta??"",this.locationType=e.locationType??Me.Custom,this.displayType=e.displayType??Re.None,this.polygonIds=[...e.polygonIds??[]],this.accessPointIds=[...e.accessPointIds??[]],this.groupId=e.groupId,this.layerId=e.layerId,this.pointId=e.pointId,this.iconUrl=e.iconUrl):(this.locationType=Me.Custom,this.displayType=Re.None,this.polygonIds=[],this.accessPointIds=[],this.groupId="",this.layerId="")}toJSON(){return{name:this.name,meta:this.meta,locationType:this.locationType,displayType:this.displayType,polygonIds:this.polygonIds,accessPointIds:this.accessPointIds,groupId:this.groupId,layerId:this.layerId,pointId:this.pointId}}},Be=class{constructor(e=[],n="public"){e&&typeof e=="object"&&Array.isArray(e.pointIds)?(this.pointIds=e.pointIds??[],this.styleId=e.styleId):(this.pointIds=Array.isArray(e)?e:[],this.styleId=n)}toJSON(){return{pointIds:this.pointIds,styleId:this.styleId}}get area(){let e=this.pointIds.map(i=>c.points[i]).filter(Boolean),n=e.length;if(n<3)return 0;let o=0;for(let i=0;i<n;i++){let s=this._pos(e[i]),r=this._pos(e[(i+1)%n]);o+=s.x*r.z-r.x*s.z}return o/2}get centroid(){let e=this.pointIds.map(s=>c.points[s]).filter(Boolean),n=e.length;if(n===0)return{x:0,z:0};let o=0,i=0;return e.forEach(s=>{let r=this._pos(s);o+=r.x,i+=r.z}),{x:o/n,z:i/n}}get fingerprint(){return this.pointIds.filter(e=>c.points[e]).slice().sort()}toggle(){this.enabled=!this.enabled}_pos(e){return{x:e.position.x,z:e.position.z}}}});function Kt(t,e={}){let{onUpdate:n=()=>{},initialPan:o={dx:0,dy:0},initialScale:i=10}=e;if(!t)throw new Error("Canvas element is required");let s={scale:i,dx:o.dx??0,dy:o.dy??0},r=oe.IDLE,a={x:0,y:0},l={[oe.IDLE]:{[pe.POINTER_DOWN]:E=>E.altKey||E.metaKey?(a.x=d(E),a.y=p(E),oe.PANNING):oe.IDLE,[pe.POINTER_MOVE]:()=>oe.IDLE,[pe.POINTER_UP]:()=>oe.IDLE,[pe.WHEEL]:E=>(m(E),oe.IDLE)},[oe.PANNING]:{[pe.POINTER_MOVE]:E=>(g(E),oe.PANNING),[pe.POINTER_UP]:()=>oe.IDLE,[pe.WHEEL]:E=>(m(E),oe.PANNING)}};function d(E){return E.touches&&E.touches.length>0?E.touches[0].clientX:E.clientX}function p(E){return E.touches&&E.touches.length>0?E.touches[0].clientY:E.clientY}function u(E,J){let Y=t.getBoundingClientRect(),q=t.width/Y.width,Ee=t.height/Y.height,lt=(E-Y.left)*q,ct=(J-Y.top)*Ee;return{x:lt,y:ct}}function g(E){let J=d(E),Y=p(E),q=u(J,Y),Ee=u(a.x,a.y),lt=q.x-Ee.x,ct=q.y-Ee.y;s.dx+=lt,s.dy+=ct,a.x=J,a.y=Y,n({...s})}function m(E){E.preventDefault();let Y=(E.deltaMode||0)===1?15:1,q=Math.exp(-E.deltaY*.001*Y),Ee=u(E.clientX,E.clientY),lt=s.scale*q,ct=Ee.x-(Ee.x-s.dx)*q,Fo=Ee.y-(Ee.y-s.dy)*q;s.scale=lt,s.dx=ct,s.dy=Fo,n({...s})}function h(E,J){let Y=l[r]?.[E];if(Y){let q=Y(J);q&&q!==r&&(r=q)}}function x(E){h(pe.POINTER_DOWN,E)}function b(E){h(pe.POINTER_MOVE,E)}function w(E){h(pe.POINTER_UP,E)}function M(E){h(pe.WHEEL,E)}return t.addEventListener("mousedown",x),t.addEventListener("mousemove",b),t.addEventListener("mouseup",w),t.addEventListener("mouseleave",w),t.addEventListener("wheel",M,{passive:!1}),t.addEventListener("touchstart",x,{passive:!1}),t.addEventListener("touchmove",b,{passive:!1}),t.addEventListener("touchend",w,{passive:!1}),{getTransform(){return{...s}},setTransform(E){s={...E},n({...s})},reset(){s={scale:1,dx:0,dy:0},n({...s})},getState(){return r},destroy(){t.removeEventListener("mousedown",x),t.removeEventListener("mousemove",b),t.removeEventListener("mouseup",w),t.removeEventListener("mouseleave",w),t.removeEventListener("wheel",M),t.removeEventListener("touchstart",x),t.removeEventListener("touchmove",b),t.removeEventListener("touchend",w)}}}var oe,pe,Lt=N(()=>{oe={IDLE:"IDLE",PANNING:"PANNING"},pe={POINTER_DOWN:"POINTER_DOWN",POINTER_MOVE:"POINTER_MOVE",POINTER_UP:"POINTER_UP",WHEEL:"WHEEL"};typeof window<"u"&&(window.createNavigator=Kt)});function Ie(t){console.log("action commited"),t.do(),Tt.push(t),Tt.length>30&&Tt.shift(),De(!0),Z(),v()}function qo(){let t=Tt.pop();t&&(t.undo(),v())}var Tt,Ot=N(()=>{X();H();Tt=[];window.addEventListener("keydown",function(t){(t.ctrlKey||t.metaKey)&&!t.shiftKey&&t.key.toLowerCase()==="z"&&(t.preventDefault(),qo())})});function ft(t,e,n,o,i,s){return{do(){if($e(),!y||y.length===0)return;let r=y.at(-1),a=c.groups[r.groupId];!a||!a.layers[r.layerId]||(e?.forEach(d=>{ge(d)}),e?.length==0&&(S.length=0),o?.forEach(d=>{ue(d)}),o?.length==0&&(T.length=0),s?.forEach(d=>{Se(d)}),s?.length==0&&(k.length=0))},undo(){if($e(),!y||y.length===0)return;let r=y.at(-1),a=c.groups[r.groupId];!a||!a.layers[r.layerId]||(t?.forEach(d=>{ge(d)}),t?.length==0&&(S.length=0),n?.forEach(d=>{ue(d)}),n?.length==0&&(T.length=0),i?.forEach(d=>{ue(d)}),i?.length==0&&(k.length=0))},redo(){this.do()}}}var Xt=N(()=>{G();H()});function Se(t){if(!y||y.length===0)return;let e=y.at(-1),n=c.groups[e.groupId];if(!n)return;let o=n.layers[e.layerId];if(!o||!o.polygons[t])return;let s=k.indexOf(t);s!==-1?k.splice(s,1):k.push(t),console.log("polygon id set to:",t)}function ue(t){if(!y||y.length===0)return;let e=y.at(-1),n=c.groups[e.groupId];if(!n)return;let o=n.layers[e.layerId];if(!o||!o.lines[t])return;let s=T.indexOf(t);s!==-1?T.splice(s,1):T.push(t)}function ge(t){if(!c.points[t])return;let n=S.indexOf(t);n!==-1?S.splice(n,1):(S.push(t),console.log("point id:"+t))}function fe(t,e){let n=c.groups[t];if(!n||e!=null&&!n.layers[e])return;let o=y.findIndex(i=>i.groupId===t&&i.layerId===e);o!==-1?y.splice(o,1):y.push({groupId:t,layerId:e})}function ie(t){ee=t,console.log("LocationId set to:",t)}function $e(){S.length=0,T.length=0,k.length=0}function En(){let t=[...T],e=[...S],n=ft(e,[],t,[]);Ie(n),F(I.IDLE),v()}function Ae(t){if(!Object.values(z).includes(t)){console.error(`Invalid selection mode: ${t}`);return}console.log(`selection mode set:  ${t}`),S.length=0,T.length=0,k.length=0,ee=null,le=t}function De(t){$t=t}var S,T,k,y,ee,$t,le,H=N(()=>{X();ce();ne();Ot();Xt();G();S=[],T=[],k=[],y=[],ee=null,$t=!1,le=null});function vn(t){let e={x:0,y:0,z:0};t.forEach(o=>{e.x+=o.position.x,e.y+=o.position.y,e.z+=o.position.z});let n=t.length;return{x:e.x/n,y:e.y/n,z:e.z/n}}function me(t){if(!je)return t;let e=c.settings.gridSize>0?Math.abs(c.settings.gridSize):1;return Math.round(t/e)*e}var ze,Zt=N(()=>{G();X();H();ze={snapToNode(t){let e=te.getTransform(),o=(c.settings.selectionRadius>0?c.settings.selectionRadius:8)/e.scale,i=null,s=o,r=y.at(-1);if(r){let a=c.groups[r.groupId];if(!a)return;let l=a.layers[r.layerId];if(!l)return;Object.values(l.lines).forEach(d=>{d.pointIds.forEach(p=>{let u=c.points[p];if(!u)return;let g=u.position.x-t.x,m=u.position.z-t.z,h=Math.hypot(g,m);h<s&&(s=h,i=p)})})}return i},pickPoint(t){let e=te.getTransform(),o=(c.settings.selectionRadius>0?c.settings.selectionRadius:8)/e.scale,i=null,s=o;return y.forEach(r=>{let a=c.groups[r.groupId];if(!a)return;let l=a.layers[r.layerId];l&&Object.values(l.lines).forEach(d=>{d.pointIds.forEach(p=>{let u=c.points[p];if(!u)return;let g=u.position.x-t.x,m=u.position.z-t.z,h=Math.hypot(g,m);h<s&&(s=h,i=p)})})}),i},snapToLocation(t){let e=te.getTransform(),o=(c.settings.selectionRadius>0?c.settings.selectionRadius:8)/e.scale,i=null,s=o;return y.forEach(r=>{let a=c.groups[r.groupId];if(!a)return;let l=a.layers[r.layerId];l&&Object.values(l.locationIds).forEach(d=>{let p=c.locations[d];if(!p)return;let u=p.center;if(!u)return;let g=u.x-t.x,m=u.y-t.z,h=Math.hypot(g,m);h<s&&(s=h,i=d)})}),i},pickLinesRect(t){let{x0:e,z0:n,x1:o,z1:i}=t,s=[],r=y.at(-1);if(r){let a=c.groups[r.groupId];if(!a)return;let l=a.layers[r.layerId];if(!l)return;Object.entries(l.lines).forEach(([d,p])=>{p.pointIds.every(g=>{let m=c.points[g];return m.position.x>=e&&m.position.x<=o&&m.position.z>=n&&m.position.z<=i})&&s.push(d)})}return s},getSelectedPolygon(t){let e=W.getBoundingClientRect(),n=t.clientX-e.left,o=t.clientY-e.top,i=W.width/e.width,s=W.height/e.height,r=Math.floor(n*i),a=Math.floor(o*s),d=we.getContext("2d").getImageData(r,a,1,1).data,p=`rgb(${d[0]},${d[1]},${d[2]})`;return Ct[p]||null},getClosestBranch(t){let e=te.getTransform(),o=(c.settings.selectionRadius>0?c.settings.selectionRadius:8)/e.scale,i=o*o,s=null,r=i,a=1/0;return y.forEach(l=>{let d=c.groups[l.groupId];if(!d)return;let p=d.layers[l.layerId];p&&Object.entries(p.lines).forEach(([u,g])=>{let m=g.pointIds.map(h=>c.points[h]);if(!(m.length<2))for(let h=0;h<m.length-1;h++){let x=m[h].position,b=m[h+1].position,w=this.pointToSegmentDistanceSq(t.x,t.z,x.x,x.z,b.x,b.z);(w<r-1e-9||Math.abs(w-r)<1e-9&&m.length<a)&&(r=w,s=u,a=m.length)}})}),s},getClosestPointOnBranches(t,e,n=0){let o={distance:1/0,x:0,z:0,segmentIndex:-1,t:0,lineId:""};return y.forEach(i=>{let s=c.groups[i.groupId];if(!s)return;let r=s.layers[i.layerId];r&&e.forEach(a=>{if(!a)return;let d=r.lines[a].pointIds.map(p=>c.points[p]);if(!(d.length<=1))for(let p=0;p<d.length-1;p++){let u=d[p].position,g=d[p+1].position,m=this.projectPointToSegment(t.x,t.z,u.x,u.z,g.x,g.z);if(n>0){let w=Math.hypot(g.x-u.x,g.z-u.z),M=w>0?n/w:0;m.t=Math.min(1-M,Math.max(M,m.t)),m.x=u.x+(g.x-u.x)*m.t,m.z=u.z+(g.z-u.z)*m.t}let h=t.x-m.x,x=t.z-m.z,b=Math.hypot(h,x);b<o.distance&&(o={distance:b,x:m.x,z:m.z,segmentIndex:p,t:m.t,lineId:a})}})}),o},pointToSegmentDistanceSq(t,e,n,o,i,s){let r=i-n,a=s-o,l=t-n,d=e-o,p=r*l+a*d,u=r*r+a*a,g=u>0?p/u:0;g=Math.max(0,Math.min(1,g));let m=n+g*r,h=o+g*a,x=t-m,b=e-h;return x*x+b*b},projectPointToSegment(t,e,n,o,i,s){let r=i-n,a=s-o,l=t-n,d=e-o,p=r*l+a*d,u=r*r+a*a,g=u>0?p/u:0;return g=Math.max(0,Math.min(1,g)),{x:n+g*r,z:o+g*a,t:g}}}});function Sn(t,e){if(!y||y.length===0)return;let n=y.at(-1),o=c.groups[n.groupId];if(!o)return;let i=o.layers[n.layerId];if(!i)return;let s=Ko(t,i.lines);if(!s){console.error("Cannot form a closed loop from selected lines:",t);return}let r=s.slice().sort().join("|"),a=Xo(r);i.polygons??={},i.polygons[a]=new Be(s,e,!0)}function Ko(t,e){if(!Array.isArray(t)||t.length===0)return null;if(t.length===1){let a=e[t[0]]?.pointIds;if(a&&a.length>=3){let l=a.slice();return l[0]!==l[l.length-1]&&l.push(l[0]),l}}let n=new Map;for(let a of t){let l=e[a]?.pointIds;if(!l||l.length<2)return null;for(let d=0;d<l.length-1;d++){let p=l[d],u=l[d+1];n.has(p)||n.set(p,[]),n.has(u)||n.set(u,[]),n.get(p).push(u),n.get(u).push(p)}}for(let[a,l]of n)if(l.length!==2)return null;let o=n.keys().next().value,i=[o],s=null,r=o;for(;;){let a=n.get(r),l=a[0]===s?a[1]:a[0];if(l===o){i.push(o);break}if(i.includes(l)||(i.push(l),s=r,r=l,i.length>n.size+1))return null}return i}function Xo(t){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e=e*16777619>>>0;return e.toString(36)}var Jt=N(()=>{G();ne();H()});function wn(){let t={},e={},n={};if(!y||y.length===0)return;let o=y.at(-1),i=c.groups[o.groupId];if(!i)return;let s=i.layers[o.layerId];if(!s)return;let r=o.groupId,a=o.layerId;return T.forEach(l=>{let d=s.lines[l];if(d){let p=new Q({styleId:d.styleId,pointIds:[...d.pointIds]});t[l]=p,d.pointIds.forEach(u=>{c.points[u].associatedLines.length<=1&&ge(u)})}}),k.forEach(l=>{let d=s.polygons[l];if(d){let p=new Be({styleId:d.styleId,pointIds:[...d.pointIds]});e[l]=p}}),S.forEach(l=>{let d=c.points[l];d&&d.associatedLines.forEach((p,u)=>{let g=s.lines[p];if(g){let m=new Q({styleId:g.styleId,pointIds:[...g.pointIds]});t[p]=m}})}),{do(){if(!y||y.length===0)return;let l=y.at(-1),d=c.groups[l.groupId];if(!d)return;let p=d.layers[l.layerId];p&&(S.forEach(u=>{let g=c.points[u];Object.entries(c.locations).forEach(([m,h])=>{if(h.pointId&&h.pointId===u){n[m]=h;let x=p.locationIds.indexOf(m);x!==-1&&p.locationIds.splice(x,1),delete c.locations[m]}}),g.associatedLines.forEach((m,h)=>{let x=p.lines[m];if(!x)return;let b=x.pointIds.indexOf(u);b!==-1&&x.pointIds.splice(b,1)})}),S.length=0,T.forEach(u=>{delete p.lines[u]}),T.length=0,k.forEach(u=>{delete p.polygons[u]}),k.length=0,F(I.IDLE),Z())},undo(){let l=c.groups[r];if(!l)return;let d=l.layers[a];d&&(Object.entries(t).forEach(([p,u])=>{d.lines[p]=u}),Object.entries(e).forEach(([p,u])=>{d.polygons[p]=u}),Object.entries(n).forEach(([p,u])=>{c.locations[p]=u,d.locationIds.push(p)}),F(I.IDLE),Z())},redo(){this.do()}}}var Pn=N(()=>{ne();G();H();X();ce()});function kn(){let t=document.getElementById("point");xe&&(xe.forEach(e=>e.classList.toggle("active",e===t)),Ae(z.POINT),W.focus(),v())}function Mn(){let t=document.getElementById("face");xe&&(xe.forEach(e=>e.classList.toggle("active",e===t)),Ae(z.POLYGON),W.focus(),v())}function Qt(){xe&&(xe.forEach(t=>t.classList.toggle("active",!1)),W.focus(),v())}function Nt(){let t=document.getElementById("edge");xe&&(xe.forEach(e=>e.classList.toggle("active",e===t)),Ae(z.LINE),W.focus(),v())}function Rn(){let t=document.getElementById("rotate"),e=document.getElementById("scale"),n=document.getElementById("centereditor"),o=document.getElementById("addpoint"),i=document.getElementById("deletenode"),s=document.getElementById("fullscreeneditor"),r=document.getElementById("adddoor"),a=document.getElementById("previewmode"),l=document.getElementById("debugmode"),d=document.getElementById("snap"),p=document.getElementById("grid"),u=document.getElementById("point"),g=document.getElementById("edge"),m=document.getElementById("face");n.addEventListener("click",()=>{console.log("click center btn "),Dn(10)}),xe=[u,g,m,o,r,t,e];function h(w,M,E){F(M),xe.forEach(J=>J.classList.toggle("active",J===w)),E&&(Ae(E),W.focus(),v())}u.addEventListener("click",()=>{h(u,I.IDLE,z.POINT),$("none")}),g.addEventListener("click",()=>{h(g,I.IDLE,z.LINE),$("none")}),m.addEventListener("click",()=>{h(m,I.IDLE,z.POLYGON),$("none")}),t.addEventListener("click",()=>{h(t,I.ROTATE)}),e.addEventListener("click",()=>{h(e,I.SCALE)}),o.addEventListener("click",()=>{h(o,I.ADD_POINT,null)}),r.addEventListener("click",()=>{h(r,I.ADD_DOOR,null)}),p.addEventListener("click",()=>{An(),Tn(),v()}),i.addEventListener("click",()=>{var w=wn();Ie(w)}),d.addEventListener("click",()=>{Gn(),zn(),v()}),a.addEventListener("click",()=>{jn(),On(),v()}),l.addEventListener("click",()=>{_n(),Cn(),v()}),s.addEventListener("click",()=>{let w=document.getElementById("wrapper");if(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen();return}w.requestFullscreen?w.requestFullscreen():w.webkitRequestFullscreen?w.webkitRequestFullscreen():w.msRequestFullscreen?w.msRequestFullscreen():(w.classList.toggle("force-fullscreen"),zt=!zt,Ln(),Ze())}),document.addEventListener("fullscreenchange",()=>{zt=!!document.fullscreenElement,Ln(),Ze()});let x=document.getElementById("styletoolbar"),b=$o();x.appendChild(b),h(u,I.IDLE,z.POINT),Tn(),zn(),On(),Cn()}function Ln(){let e=document.getElementById("fullscreeneditor").querySelector("img");e&&(e.src=zt?"https://cdn.jsdelivr.net/gh/elseforty/IndoorLens/LocationIcons/Minimize.png":"https://cdn.jsdelivr.net/gh/elseforty/IndoorLens/LocationIcons/Maximize.png")}function Tn(){let t=document.getElementById("grid");t.innerHTML="";let e=null;Ne?e="/Images/ShowGrid.png":e="/Images/HideGrid.png",t.style.backgroundImage=`url("${e}")`,t.style.backgroundSize="contain",t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="center",t.style.backgroundSize="16px 16px"}function On(){let t=document.getElementById("previewmode");t.innerHTML="";let e=null;_e?e="/Images/PreviewOn.png":e="/Images/PreviewOff.png",t.style.backgroundImage=`url("${e}")`,t.style.backgroundSize="contain",t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="center",t.style.backgroundSize="16px 16px"}function Cn(){let t=document.getElementById("debugmode");t.innerHTML="";let e=null;Qe?e="/Images/DebugOn.png":e="/Images/DebugOff.png",t.style.backgroundImage=`url("${e}")`,t.style.backgroundSize="contain",t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="center",t.style.backgroundSize="16px 16px"}function zn(){let t=document.getElementById("snap");t.innerHTML="";let e=null;je?e="/Images/SnapOn.png":e="/Images/SnapOff.png",t.style.backgroundImage=`url("${e}")`,t.style.backgroundSize="contain",t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="center",t.style.backgroundSize="16px 16px"}function $o(){let t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.gap="2px",t.style.whiteSpace="nowrap",t.id="toolbar";function e(o,i,s){let r=c.styles[o],a=document.createElement("div");Object.assign(a.style,{width:"24px",height:"30px",display:"flex",flexDirection:"column",alignItems:"stretch",border:"1px solid #333",boxSizing:"border-box",cursor:"pointer"}),a.title=i;let l=document.createElement("div");Object.assign(l.style,{height:"24px",background:o==="none"?"transparent":s,backgroundImage:o==="none"?'url("/Images/None.png")':"none",backgroundSize:"16px 16px",backgroundPosition:"center",backgroundRepeat:"no-repeat"});let d=document.createElement("div");return Object.assign(d.style,{height:"6px",background:r.enabled?Yt:qt,display:"flex",alignItems:"center",justifyContent:"center",userSelect:"none"}),l.addEventListener("click",p=>{if(p.stopPropagation(),console.log("style id is ",o),!y||y.length===0)return;let u=y.at(-1),g=c.groups[u.groupId];if(!g)return;let m=g.layers[u.layerId];m&&(["innerwall","outerwall"].includes(o)?(T.forEach(h=>{let x=m.lines[h];x&&(x.styleId=o)}),T.length=0):["floor","public","private"].includes(o)?Zo(o):o==="none"&&(T.forEach(h=>{let x=m.lines[h];x&&(x.styleId=o)}),T.length=0),Z(),v())}),d.addEventListener("click",p=>{p.stopPropagation(),Object.entries(c.styles).forEach(([u,g])=>{u===o&&(g.enabled=!g.enabled)}),d.style.background=r.enabled?Yt:qt,v()}),a.appendChild(l),a.appendChild(d),a}t.appendChild(document.createTextNode("Wall:")),t.appendChild(e("innerwall","Inner Wall",wt)),t.appendChild(e("outerwall","Outer Wall",Pt)),t.appendChild(e("none","Clear Wall Style",null));let n=document.createElement("div");return n.style.width="16px",t.appendChild(n),t.appendChild(document.createTextNode("Surface:")),t.appendChild(e("floor","Floor Surface Color",Et)),t.appendChild(e("public","Public Surface Color",vt)),t.appendChild(e("private","Private Surface Color",St)),t}function Bn(t){let e=c.points[t];if(!e||e.locationId)return;let n=new gt;n.groupId=e.groupId,n.layerId=e.layerId,n.pointId=t,n.name="Location Name";let o=K();e.locationId=o;let i=c.groups[e.groupId];if(!i)return;let s=i.layers[e.layerId];s&&(s.locationIds.push(o),c.locations[o]=n,ie(o))}function Zo(t){if(!y||y.length===0)return;let e=y.at(-1),n=c.groups[e.groupId];if(!n)return;let o=n.layers[e.layerId];o&&(k.forEach(i=>{let s=o.polygons[i];s&&(s.styleId=t)}),Sn(T,t),k.length=0)}var zt,xe,Nn,Je=N(()=>{ne();Ce();G();X();ce();Ot();Pn();Jt();H();Pe();zt=!1,xe=null,Nn=document.createElement("style");Nn.innerHTML=`
#canvasroot.force-fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
}
`;document.head.appendChild(Nn)});function Fn(t,e){A=t,se=e;function n(o){let i=window.devicePixelRatio||1,s=A.getBoundingClientRect(),r=(o.clientX-s.left)*i,a=(o.clientY-s.top)*i,l=te.getTransform(),d=(r-l.dx)/l.scale,p=(a-l.dy)/l.scale;Wn({x:d,z:p},{x:d,z:p}),mt(O.POINTER_MOVE,o),se()}A.addEventListener("dblclick",o=>{mt(O.DOUBLE_CLICK,o)}),A.addEventListener("pointerdown",o=>{mt(O.POINTER_DOWN,o)}),A.addEventListener("pointermove",n),A.addEventListener("pointerrawmove",n),A.addEventListener("pointerup",o=>{mt(O.POINTER_UP,o)}),window.addEventListener("keydown",o=>{o.key==="Escape"&&(En(),F(I.IDLE))}),A.addEventListener("contextmenu",o=>{o.ctrlKey&&o.preventDefault()})}var A,se,en=N(()=>{X();Lt();ce();H();ne();Jt();G();Je();A=null,se=null});function kt(t){if(!t)return;let e=new Q;return e.styleId=t.styleId,e.pointIds=[...t.pointIds],e}var tn=N(()=>{ne()});function Un(t,e,n){let o=[],i={};return{do(){if(!e||!n||!y||y.length===0)return;let s=y.at(-1),r=c.groups[s.groupId];if(!r)return;let a=r.layers[s.layerId];if(!a)return;let l=a.lines[t.lineId];if(!l)return;i[t.lineId]=kt(l);let d=et(e);if(!d){let M=new ve;M.groupId=s.groupId,M.layerId=s.layerId,M.position=new de({x:e.x,y:0,z:e.z}),d=K(),c.points[d]=M}let p=new ve;p.groupId=s.groupId,p.layerId=s.layerId,p.position=new de({x:t.x,y:0,z:t.z});let u=K();c.points[u]=p;let g=et(n);if(!g){let M=new ve;M.groupId=s.groupId,M.layerId=s.layerId,M.position=new de({x:n.x,y:0,z:n.z}),g=K(),c.points[g]=M}let m=t.segmentIndex+1;l.pointIds.splice(m,0,g,d);let h=l.pointIds.slice(0,m+1),x=l.pointIds.slice(m+1);if(l.pointIds=h.slice(),x.length>=2){let M=new Q;M.styleId=l.styleId;let E=K();M.pointIds=x.slice(),a.lines[E]=M,o.push(E)}let b=new Q;b.styleId="none";let w=K();b.isDoor=!0,b.pointIds=[g,u,d],a.lines[w]=b,o.push(w),Z(),$e(),Nt(),F(I.IDLE)},undo(){if(!y||y.length===0)return;let s=y.at(-1),r=c.groups[s.groupId];if(!r)return;let a=r.layers[s.layerId];a&&(Object.entries(i).forEach(([l,d])=>{a.lines[l]=d}),o.forEach(l=>{delete a.lines[l]}),Z(),$e(),F(I.IDLE))},redo(){this.do()}}}var Hn=N(()=>{ne();Ce();G();X();tn();ce();Je();H()});function Yn(){let t=[],e={},n=[];return{do(){return j.safeExecute(()=>{t.length=0,e={},n.length=0,yt=t;let o=tt.getSelectionContext();if(!o){j.warn("No valid selection context");return}let i=Math.abs(c.settings.gridSize)>0?Math.abs(c.settings.gridSize)*nt.SNAP_TOLERANCE_MULTIPLIER:1,s=et(D),r,a;if(s){if(console.log("Using snap point"),r=V.getPoint(s),a=s,!r){j.error("Snap point not found in map");return}}else{console.log("Creating new point");let l=V.createPoint(D,o.selection.groupId,o.selection.layerId);r=l.point,a=l.pointId,n.push(a)}if(tt.hasPointSelection()){let l=tt.getSelectedPointId();Vn.handlePointSelection(o,l,r,a,t,e,n)}else Vn.handleNoSelection(o,r,a,t,e);tt.updateSelection(a),Z(),F(I.ADD_POINT)},"add command execution",()=>{this.undo()})},undo(){return j.safeExecute(()=>{yt=null;let o=tt.getSelectionContext();o&&(t.forEach(i=>{o.layer.lines[i]&&delete o.layer.lines[i]}),Object.keys(e).forEach(i=>{e[i]&&(o.layer.lines[i]=e[i])}),n.forEach(i=>{let s=!1;Object.values(c.groups).forEach(r=>{s||Object.values(r.layers).forEach(a=>{s||Object.values(a.lines).forEach(l=>{l&&l.pointIds&&l.pointIds.includes(i)&&(s=!0)})})}),!s&&c.points[i]&&delete c.points[i]}),t.length=0,e={},n.length=0,Z())},"add command undo")}}}var Jo,Qo,nt,Ge,yt,j,V,be,tt,nn,on,Vn,qn=N(()=>{Ce();ne();G();H();X();ce();tn();ce();Jo=1e-6,Qo=1,nt={EPSILON:Jo,SNAP_TOLERANCE_MULTIPLIER:Qo,DEFAULT_Y_COORDINATE:0},Ge={floatEquals(t,e,n=nt.EPSILON){return Math.abs(t-e)<n},isInMiddleRange(t,e=nt.EPSILON){return t>e&&t<1-e},isValidIndex(t,e){return Array.isArray(t)&&e>=0&&e<t.length},distance(t,e){return Math.hypot(e.x-t.x,e.z-t.z)},boundingBoxesOverlap(t,e){return!(t.maxX<e.minX||e.maxX<t.minX||t.maxZ<e.minZ||e.maxZ<t.minZ)}},yt=null,j={warn(t,e={}){console.warn(`[GeometryEditor] ${t}`,e)},error(t,e,n={}){console.error(`[GeometryEditor] ${t}`,e,n)},safeExecute(t,e,n=null){try{return t()}catch(o){return this.error(`Failed to execute ${e}`,o),n}}},V={createPoint(t,e,n){let o=new ve;o.groupId=e,o.layerId=n,o.position=new de(t),o.associatedLines=[];let i=K();return c.points[i]=o,{point:o,pointId:i}},addLineToPoint(t,e){let n=c.points[t];if(!n){j.warn("Point not found for line association",{pointId:t,lineId:e});return}Array.isArray(n.associatedLines)||(n.associatedLines=[]),n.associatedLines.includes(e)||n.associatedLines.push(e)},removeLineFromPoint(t,e){let n=c.points[t];!n||!Array.isArray(n.associatedLines)||(n.associatedLines=n.associatedLines.filter(o=>o!==e))},getPoint(t){let e=c.points[t];return e||(j.warn("Point not found",{pointId:t}),null)}},be={createLine(t,e,n=null){let o=new Q(n);n&&(o.styleId=n);let i=K(),s=tt.getSelectionContext();return s&&s.layer&&(s.layer.lines[i]=o),{line:o,lineId:i}},safeBranchClone(t,e){return j.safeExecute(()=>e.lines[t]?kt(e.lines[t]):null,"branch cloning")},getLine(t,e){let n=e.lines[t];return n||(j.warn("Line not found",{lineId:t}),null)}},tt={getSelectionContext(){if(!y||y.length===0)return j.warn("No selection context available"),null;let t=y.at(-1),e=c.groups[t.groupId];if(!e)return j.warn("Group not found in selection",{groupId:t.groupId}),null;let n=e.layers[t.layerId];return n?{selection:t,group:e,layer:n}:(j.warn("Layer not found in selection",{layerId:t.layerId}),null)},updateSelection(t){S.length=0,ge(t)},hasPointSelection(){return S&&S.length===1},getSelectedPointId(){return this.hasPointSelection()?S[0]:null}},nn={processSingleHit(t,e,n,o){return j.safeExecute(()=>{if(!n||!n.lineId||!e){j.warn("Invalid parameters for intersection processing");return}let i=be.getLine(n.lineId,t.layer);if(!i||!Ge.isValidIndex(i.pointIds,n.segmentIndex)){j.warn("Invalid line or segment index",{lineId:n.lineId,segmentIndex:n.segmentIndex});return}if(Ge.floatEquals(n.t,0)||Ge.floatEquals(n.t,1))console.log("Intersection at segment endpoint"),this.breakBranchAtNode(e);else if(Ge.isInMiddleRange(n.t)){console.log("Intersection in middle of segment");let s=n.segmentIndex;i.pointIds.splice(s+1,0,e),this.breakBranchAtNode(e)}o.includes(n.lineId)||o.push(n.lineId)},"single hit processing")},processMultipleHits(t,e,n,o){return j.safeExecute(()=>{if(!Array.isArray(n)||!Array.isArray(o)){j.warn("Invalid parameters for multiple hits processing");return}n.forEach(i=>{i&&i.lineId&&this.processSingleHit(t,i.newPointId,i,o)})},"multiple hits processing")},breakBranchAtNode(t){let e=V.getPoint(t);if(!e||!Array.isArray(e.associatedLines))return;let n=c.groups[e.groupId];if(!n)return;let o=n.layers[e.layerId];if(!o)return;[...e.associatedLines].forEach(s=>{let r=o.lines[s];if(!r)return;let a=r.pointIds.indexOf(t);if(a<=0||a>=r.pointIds.length-1)return;let l=K(),d=new Q(r.styleId);d.styleId=r.styleId,o.lines[l]=d,yt&&!yt.includes(l)&&yt.push(l);let p=r.pointIds.slice(0,a+1),u=r.pointIds.slice(a);r.pointIds=p,d.pointIds=u,u.forEach(g=>{V.getPoint(g)&&(g!==t&&V.removeLineFromPoint(g,s),V.addLineToPoint(g,l))}),V.addLineToPoint(t,l)})}},on={findPointOnAnySegment(t,e=nt.EPSILON){if(!t||!y)return j.warn("Invalid parameters for point-on-segment test"),null;let{x:n,z:o}=t;return j.safeExecute(()=>{for(let i of y){let s=c.groups[i.groupId];if(!s)continue;let r=s.layers[i.layerId];if(r)for(let[a,l]of Object.entries(r.lines)){if(!l||!l.pointIds)continue;let d=l.pointIds.map(p=>V.getPoint(p)).filter(Boolean);if(!(d.length<2))for(let p=0;p<d.length-1;p++){let u=this.testPointOnSegment({x:n,z:o},d[p].position,d[p+1].position,e);if(u)return{lineId:a,segmentIndex:p,t:u.t,x:n,z:o}}}}return null},"point-on-segment calculation")},testPointOnSegment(t,e,n,o){let{x:i,z:s}=t,{x:r,z:a}=e,{x:l,z:d}=n,p=Math.min(r,l)-o,u=Math.max(r,l)+o,g=Math.min(a,d)-o,m=Math.max(a,d)+o;if(i<p||i>u||s<g||s>m)return null;let h=l-r,x=d-a,b=i-r,w=s-a,M=Math.abs(h*w-x*b),E=Math.hypot(h,x);if(E<o)return null;if(M/E<=o){let Y=(b*h+w*x)/(E*E);return{t:Math.max(0,Math.min(1,Y))}}return null},findIntersections(t,e,n){if(!e||!n||!y)return j.warn("Invalid parameters for intersection calculation"),[];let o=[],i=n.x-e.x,s=n.z-e.z;return j.safeExecute(()=>(y.forEach(r=>{let a=c.groups[r.groupId];if(!a)return;let l=a.layers[r.layerId];l&&Object.entries(l.lines).forEach(([d,p])=>{if(d===t||!p||!p.pointIds)return;let u=p.pointIds.map(g=>V.getPoint(g)).filter(Boolean);if(!(u.length<2))for(let g=0;g<u.length-1;g++){let m=this.calculateSegmentIntersection(e,n,u[g].position,u[g+1].position);m&&o.push({lineId:d,x:m.x,z:m.z,segmentIndex:g,t:m.t,u:m.u})}})}),o),"intersection calculation",[])},calculateSegmentIntersection(t,e,n,o){let i=e.x-t.x,s=e.z-t.z,r=o.x-n.x,a=o.z-n.z,l={minX:Math.min(t.x,e.x),maxX:Math.max(t.x,e.x),minZ:Math.min(t.z,e.z),maxZ:Math.max(t.z,e.z)},d={minX:Math.min(n.x,o.x),maxX:Math.max(n.x,o.x),minZ:Math.min(n.z,o.z),maxZ:Math.max(n.z,o.z)};if(!Ge.boundingBoxesOverlap(l,d))return null;let p=i*-a-s*-r;if(Math.abs(p)<nt.EPSILON)return null;let u=n.x-t.x,g=n.z-t.z,m=(u*-a-g*-r)/p,h=(i*g-s*u)/p;if(m>=0&&m<=1&&h>=0&&h<=1){let x=t.x+m*i,b=t.z+m*s;return{x,z:b,t:m,u:h}}return null}},Vn={handlePointSelection(t,e,n,o,i,s,r){let a=V.getPoint(e);if(!a||!a.associatedLines||a.associatedLines.length===0){j.warn("Selected point has no associated lines");return}let l=a.associatedLines[0],d=be.getLine(l,t.layer);if(!d){j.warn("Target line not found",{lineId:l});return}s[l]||(s[l]=be.safeBranchClone(l,t.layer)),a.associatedLines.length===1?this.handleNonSharedPoint(t,e,a,n,o,l,d,i,s,r):this.handleSharedPoint(t,e,a,n,o,i,s,r)},handleNonSharedPoint(t,e,n,o,i,s,r,a,l,d){console.log("Selected point is not shared \u2013 creating fresh 2-point line");let{line:p,lineId:u}=be.createLine(t.selection.groupId,t.selection.layerId);p.pointIds.push(e,i),V.addLineToPoint(e,u),V.addLineToPoint(i,u),this.handleEndpointIntersection(o.position,i,u,t,l,a),ue(u),a.push(u),r.pointIds.length===1&&this.cleanupSinglePointLine(s,n,t,a),this.handleSegmentIntersections(n.position,o.position,u,p,t,l,a,d)},handleSharedPoint(t,e,n,o,i,s,r,a){console.log("Selected point is shared");let{line:l,lineId:d}=be.createLine(t.selection.groupId,t.selection.layerId);l.pointIds.push(e,i),V.addLineToPoint(e,d),V.addLineToPoint(i,d),this.handleEndpointIntersection(o.position,i,d,t,r,s),ue(d),s.push(d),this.handleSegmentIntersections(n.position,o.position,d,l,t,r,s,a)},handleNoSelection(t,e,n,o,i){console.log("No point selected");let s=on.findPointOnAnySegment(e.position);if(s){console.log("Point intersects existing line");let r=be.getLine(s.lineId,t.layer);!o.includes(s.lineId)&&!i[s.lineId]&&(i[s.lineId]=be.safeBranchClone(s.lineId,t.layer)),nn.processSingleHit(t,n,s,o)}else{console.log("No intersection - creating new line");let{line:r,lineId:a}=be.createLine(t.selection.groupId,t.selection.layerId);ue(a),o.push(a),r.pointIds.push(n),V.addLineToPoint(n,a)}},handleEndpointIntersection(t,e,n,o,i,s){let r=on.findPointOnAnySegment(t);r&&r.lineId!==n&&(r.newPointId=e,V.addLineToPoint(e,r.lineId),!s.includes(r.lineId)&&!i[r.lineId]&&(i[r.lineId]=be.safeBranchClone(r.lineId,o.layer)),nn.processSingleHit(o,e,r,s))},handleSegmentIntersections(t,e,n,o,i,s,r,a){let l=on.findIntersections(n,{x:t.x,z:t.z},{x:e.x,z:e.z}).sort((p,u)=>p.t-u.t),d=1;l.forEach(p=>{if(!Ge.isInMiddleRange(p.t)){p.newPointId=Ge.floatEquals(p.t,0)?o.pointIds[0]:o.pointIds[o.pointIds.length-1];return}let{point:u,pointId:g}=V.createPoint({x:p.x,y:nt.DEFAULT_Y_COORDINATE,z:p.z},i.selection.groupId,i.selection.layerId);a.push(g),V.addLineToPoint(g,n),V.addLineToPoint(g,p.lineId),p.newPointId=g,o.pointIds.splice(d,0,g),d+=1}),l.forEach(p=>{!r.includes(p.lineId)&&!s[p.lineId]&&(s[p.lineId]=be.safeBranchClone(p.lineId,i.layer))}),l.forEach(p=>{p.t=p.u}),nn.processMultipleHits(i,o,l,r)},cleanupSinglePointLine(t,e,n,o){o.includes(t)||o.push(t),n.layer.lines[t]&&delete n.layer.lines[t],e.associatedLines=e.associatedLines.filter(i=>i!==t)}}});function Kn(t,e){return{do(){e.forEach(n=>{if(!y||y.length===0)return;let o=y.at(-1),i=c.groups[o.groupId];if(!i||!i.layers[o.layerId])return;let r=c.points[n.pointId];r&&(r.position.x=n.x,r.position.z=n.z)})},undo(){t.forEach(n=>{if(!y||y.length===0)return;let o=y.at(-1),i=c.groups[o.groupId];if(!i||!i.layers[o.layerId])return;let r=c.points[n.pointId];r&&(r.position.x=n.x,r.position.z=n.z)})},redo(){this.do()}}}var Xn=N(()=>{G();H()});function $n(){function t(h,x){let b=document.createElement("div");b.className="field-group",b.style.marginBottom="8px";let w=document.createElement("label");return w.textContent=h,w.htmlFor=x.id,b.appendChild(w),b.appendChild(x),b}let e=document.getElementById("locationFieldsContainer");e.innerHTML="";let n=document.createElement("input");n.type="text",n.id="locationName",n.value="",n.addEventListener("input",h=>{let x=ht();if(!x)return null;x.name=h.target.value,ye()}),e.appendChild(t("Name:",n));let o=document.createElement("textarea");o.id="locationMeta",o.rows=3,o.style.resize="vertical",o.value="",o.placeholder="e.g. Layer 2, East Wing",o.addEventListener("input",h=>{let x=ht();x&&(x.meta=h.target.value)}),e.appendChild(t("Meta Data:",o));let i=document.createElement("select");i.id="locationType",Object.entries(Me).forEach(([h,x])=>{let b=document.createElement("option");b.value=x,b.textContent=h,i.appendChild(b)}),i.value=Me.Custom,i.addEventListener("change",h=>{let x=ht();if(!x)return null;x.locationType=h.target.value}),e.appendChild(t("Location Type:",i));let s=document.createElement("select");s.id="displayType",Object.entries(Re).forEach(([h,x])=>{let b=document.createElement("option");b.value=x,b.textContent=h,s.appendChild(b)}),s.value=Re.None,s.addEventListener("change",h=>{let x=ht();if(!x)return null;x.displayType=h.target.value}),e.appendChild(t("Display Type:",s));let r=document.createElement("div");r.className="field-group",r.style.display="grid",r.style.gridTemplateColumns="auto 1fr";let a=document.createElement("label");a.textContent="Surfaces",a.style.marginRight="auto",r.appendChild(a);let l=document.createElement("button");l.type="button",l.className="btn-img",l.style.backgroundImage="url(/Images/Pick.png)",l.style.backgroundRepeat="no-repeat",l.style.backgroundPosition="center",l.style.backgroundSize="16px 16px",l.style.justifySelf="end",l.onclick=h=>{F(I.PICK_POLYGON),Fe()},r.appendChild(l),e.appendChild(r);let d=document.createElement("div");d.id="surfacesTags",d.className="tagContainer",d.style.display="flex",d.style.flexWrap="wrap",d.style.justifyContent="flex-start",e.appendChild(d);let p=document.createElement("div");p.className="field-group",p.style.display="grid",p.style.gridTemplateColumns="auto 1fr";let u=document.createElement("label");u.textContent="Access Points",u.style.marginRight="auto",p.appendChild(u);let g=document.createElement("button");g.type="button",g.className="btn-img",g.style.backgroundImage="url(/Images/Pick.png)",g.style.backgroundRepeat="no-repeat",g.style.backgroundPosition="center",g.style.backgroundSize="16px 16px",g.style.justifySelf="end",g.onclick=h=>{F(I.PICK_POINT),Fe()},p.appendChild(g),e.appendChild(p);let m=document.createElement("div");m.id="accessPointsTags",m.className="tagContainer",m.style.display="flex",m.style.flexWrap="wrap",m.style.justifyContent="flex-start",e.appendChild(m)}function Fe(){let t=ht();if(!t)return null;t.polygonIds.forEach(s=>Se(s)),v(),console.log("location.name"+t.name);let e=document.getElementById("locationName");e.value=t.name||"";let n=document.getElementById("locationMeta");n.value=t.meta||"";let o=document.getElementById("displayType");o.value=t.displayType||Re.None;let i=document.getElementById("locationType");i.value=t.locationType||Me.Custom,Zn(t.polygonIds),Jn(t.accessPointIds)}function ht(){return console.log("locationId"+ee),c.locations[ee]}function Zn(t){let e=document.getElementById("surfacesTags");e.innerHTML="",k.length=0,t.forEach((n,o)=>{Se(n);let i=document.createElement("span");i.className="tag-pill",i.textContent=n.length>3?n.slice(0,2)+"...":n,i.addEventListener("click",()=>{Se(n),v()});let s=document.createElement("button");s.type="button",s.className="close-btn",s.innerHTML="&times;",s.addEventListener("click",()=>{t.splice(o,1),Zn(t),v()}),i.appendChild(s),e.appendChild(i)})}function Jn(t){let e=document.getElementById("accessPointsTags");e.innerHTML="",t.forEach((n,o)=>{let i=document.createElement("span");i.className="tag-pill",i.textContent=n.length>3?n.slice(0,2)+"...":n,i.addEventListener("click",()=>{S.length=0,ge(n),v()});let s=document.createElement("button");s.type="button",s.className="close-btn",s.innerHTML="&times;",s.addEventListener("click",()=>{t.splice(o,1),Jn(t),v()}),i.appendChild(s),e.appendChild(i)})}var sn=N(()=>{Ce();G();X();H();Pe();ce()});function Mt(){if(S.length!==1)return;let t=S[0],e=c.points[t],n=document.getElementById("pointContainer");n.innerHTML="",n.innerHTML="";let o=document.createElement("div");o.className="field-group",o.style.display="grid",o.style.gridTemplateColumns="auto 1fr";let i=document.createElement("label");i.textContent="Twins",o.appendChild(i);let s=document.createElement("button");s.type="button",s.className="btn-img",Object.assign(s.style,{backgroundImage:"url(/Images/Pick.png)",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"16px 16px",justifySelf:"end"}),s.onclick=()=>{F(I.PICK_POINT),v()},o.appendChild(s),n.appendChild(o);let r=document.createElement("div");r.id="twinsTags",r.className="tagContainer",Object.assign(r.style,{display:"flex",flexWrap:"wrap",justifyContent:"flex-start"}),n.appendChild(r),Qn(e.twins??[],r,e)}function Qn(t,e,n){e.innerHTML="",t.forEach((o,i)=>{let s=document.createElement("span");s.className="tag-pill",s.textContent=o.length>3?o.slice(0,2)+"\u2026":o,s.addEventListener("click",()=>{S.length=0,setPointId(o),v()});let r=document.createElement("button");r.type="button",r.className="close-btn",r.innerHTML="&times;",r.addEventListener("click",a=>{a.stopPropagation(),t.splice(i,1),n.twins=[...t],Qn(t,e,n),v()}),s.appendChild(r),e.appendChild(s)})}var rn=N(()=>{ce();X();H();G()});function It(){C.active=!1,C.pointStarts.clear(),C.pointIds.length=0}function cn(){ln||(ln=requestAnimationFrame(()=>{ln=null,se()}))}function to(t,e){an={...D},Ue=S.map(r=>({...c.points[r].position}));let n=vn(S.map(r=>c.points[r]));_={x:me(n.x),y:me(n.y),z:me(n.z)},S.forEach(r=>{let a=c.points[r];a.position.x+=_.x-n.x,a.position.z+=_.z-n.z});let o=an.x-_.x,i=an.z-_.z;no=Math.atan2(i,o),Bt=Math.hypot(o,i),dn={x:o,z:i};let s=Ue.map(r=>Math.hypot(r.x-_.x,r.z-_.z));return ei=s.length?Math.max(...s):0,C.pointIds=[...S],C.pointStarts.clear(),C.pointIds.forEach(r=>C.pointStarts.set(r,{x:c.points[r].position.x,z:c.points[r].position.z})),C.startScrX=t.clientX,C.startScrY=t.clientY,C.startWorld={...D},C.active=!0,A.setPointerCapture(t.pointerId),se(),e}function ti(t){console.log("Editing FSM handlers registered for states:",Object.keys(t)),oo=t||{}}function mt(t,e){let n=oo[ot]?.[t];if(n){let o=n(e);o&&o!==ot&&(ot=o)}}function pn(){return ot}function Wn(t,e){D={x:me(t.x),z:me(t.z)},Rt=e}function F(t){if(Object.values(I).includes(t))switch(ot=t,console.log(`Current state: ${t}`),ot){case I.ROTATE:A.style.cursor="alias";break;case I.SCALE:A.style.cursor="nwse-resize";break;case I.ADD_DOOR:break;case I.ADD_POINT:A.style.cursor="crosshair";break;case I.IDLE:switch(P.setTransform(1,0,0,1,0,0),P.clearRect(0,0,R.width,R.height),A.style.cursor="default",le){case z.POINT:{kn();break}case z.LINE:Nt();break;case z.POLYGON:Mn();break}break;case I.PICK_POLYGON:A.style.cursor="crosshair",Qt();break;case I.PICK_POINT:A.style.cursor="crosshair",Qt();break;default:A.style.cursor="default";break}else console.warn(`Invalid FSM state: ${t}`)}function ni(t,e){let n=window.devicePixelRatio||1,o=R.width/n,i=R.height/n,s=te.getTransform(),r=(t-o/2-s.dx)/s.scale,a=(e-i/2-s.dy)/s.scale;return{x:r,z:a}}var I,O,ot,C,eo,D,Rt,Le,re,We,an,Ue,no,Bt,ei,dn,_,ln,oo,ce=N(()=>{ne();H();X();G();Zt();en();Lt();Zt();Ot();Hn();qn();Xt();Xn();Pe();Je();sn();rn();I={IDLE:"Idle",RECT_SELECTING:"RectSelecting",READY_TO_DRAG:"ReadyToDrag",DRAGGING:"Dragging",ROTATE:"Rotate",SCALE:"Scale",ADD_POINT:"AddNode",ADD_DOOR:"AddDoor",PICK_POLYGON:"PickPolygon",PICK_POINT:"PickPoint"},O={POINTER_DOWN:"POINTER_DOWN",POINTER_MOVE:"POINTER_MOVE",POINTER_UP:"POINTER_UP",KEY_DOWN:"KEY_DOWN",KEY_UP:"KEY_UP",DOUBLE_CLICK:"DOUBLE_CLICK"},ot=I.IDLE,C={active:!1,startScrX:0,startScrY:0,startWorld:{x:0,z:0},pointStarts:new Map,pointIds:[]},eo=3,re={active:!1,x0:0,y0:0,x1:0,y1:0};ln=null;oo={};ti({[I.IDLE]:{[O.POINTER_DOWN]:t=>{t.button===2&&t.preventDefault(),It();let e=t.metaKey||t.ctrlKey;if(te.getState()===oe.PANNING&&e)return I.IDLE;let o={points:[...S],lines:[...T],polygons:[...k]},i=ze.snapToNode(Rt),s=ze.getClosestBranch(Rt),r=ze.getSelectedPolygon(t);switch(le){case z.POINT:{if(!i)break;let l=S.indexOf(i);if(e)l>=0?S.splice(l,1):ge(i);else if(!(S.length>1&&l>=0)){S.length=0,S.push(i);let d=c.points[i];d.locationId?(ie(d.locationId),$("location")):(ie(null),$("point")),d.twins&&console.log("twings :",d.twins)}return C.pointIds=[...S],C.pointStarts.clear(),C.pointIds.forEach(d=>{let p=c.points[d].position;C.pointStarts.set(d,{x:p.x,z:p.z})}),C.startScrX=t.clientX,C.startScrY=t.clientY,C.startWorld={...D},A.setPointerCapture(t.pointerId),I.READY_TO_DRAG}case z.LINE:{if(!s)break;let l=T.indexOf(s);e?l>=0?T.splice(l,1):ue(s):(T.length=0,ue(s));break}case z.POLYGON:{if(!r)return;let l=k.indexOf(r);e?l>=0?k.splice(l,1):Se(r):(k.length=0,Se(r)),console.log("polygonIds.length",k.length);break}}let a={points:[...S],lines:[...T],polygons:[...k]};if((o.points.join(",")!==a.points.join(",")||o.lines.join(",")!==a.lines.join(",")||o.polygons.join(",")!==a.polygons.join(","))&&Ie(ft(o.points,a.points,o.lines,a.lines,o.polygons,a.polygons)),!e&&le!==z.POLYGON&&!i&&!s){let l=R.getBoundingClientRect();return R.getContext("2d").clearRect(0,0,R.width,R.height),re.active=!0,A.setPointerCapture(t.pointerId),re.x0=t.clientX-l.left,re.y0=t.clientY-l.top,re.x1=re.x0,re.y1=re.y0,We={x:D.x,z:D.z},I.RECT_SELECTING}return se(),I.IDLE},[O.DOUBLE_CLICK]:t=>(t.button===0&&(S.length=0,T.length=0,k.length=0),se(),I.IDLE),[O.POINTER_MOVE]:()=>{I.IDLE},[O.POINTER_UP]:()=>I.IDLE},[I.RECT_SELECTING]:{[O.POINTER_MOVE]:t=>{let e=R.getBoundingClientRect();return re.x1=t.clientX-e.left,re.y1=t.clientY-e.top,ro(re),I.RECT_SELECTING},[O.POINTER_UP]:t=>{R.getContext("2d").clearRect(0,0,R.width,R.height),A.releasePointerCapture(t.pointerId),re.active=!1;let n=We!==void 0?We:ni(re.x0,re.y0),o=Math.min(We.x,D.x),i=Math.min(We.z,D.z),s=Math.max(We.x,D.x),r=Math.max(We.z,D.z),a=[...S],l=[...T],d=[...k],p=new Set,u=new Set,g=new Set;switch(le){case z.POINT:{let b=y.at(-1);if(b){let w=c.groups[b.groupId];if(!w)return;let M=w.layers[b.layerId];if(!M)return;Object.entries(M.lines).forEach(([E,J])=>{J.pointIds.forEach(Y=>{if(p.has(Y))return;let q=c.points[Y].position;q.x>=o&&q.x<=s&&q.z>=i&&q.z<=r&&p.add(Y)})})}if(p.length==1){let w=c.points[p[0]];w.locationId?(ie(w.locationId),$("location")):(ie(null),$("point"))}break}case z.LINE:ze.pickLinesRect({x0:o,z0:i,x1:s,z1:r}).forEach(b=>{u.has(b)||u.add(b)});break;case z.POLYGON:break}let m=Array.from(p),h=Array.from(u),x=Array.from(g);return(JSON.stringify(a)!==JSON.stringify(m)||JSON.stringify(l)!==JSON.stringify(h)||JSON.stringify(d)!==JSON.stringify(x))&&Ie(ft(a,m,l,h,d,x)),se(),I.IDLE}},[I.READY_TO_DRAG]:{[O.POINTER_MOVE]:t=>{let e=t.clientX-C.startScrX,n=t.clientY-C.startScrY;return Math.abs(e)>eo||Math.abs(n)>eo?I.DRAGGING:I.READY_TO_DRAG},[O.POINTER_UP]:t=>(A.releasePointerCapture(t.pointerId),It(),se(),I.IDLE),[O.POINTER_DOWN]:()=>I.READY_TO_DRAG,[O.KEY_DOWN]:()=>I.READY_TO_DRAG,[O.KEY_UP]:()=>I.READY_TO_DRAG},[I.DRAGGING]:{[O.POINTER_MOVE]:t=>{let e=D.x-C.startWorld.x,n=D.z-C.startWorld.z;return C.pointIds.forEach(o=>{let i=C.pointStarts.get(o);c.points[o].position.x=me(i.x+e),c.points[o].position.z=me(i.z+n)}),cn(),I.DRAGGING},[O.POINTER_UP]:t=>{let e=C.pointIds.map(i=>({pointId:i,x:C.pointStarts.get(i).x,z:C.pointStarts.get(i).z})),n=C.pointIds.map(i=>({pointId:i,x:c.points[i].position.x,z:c.points[i].position.z}));if(e.some((i,s)=>i.x!==n[s].x||i.z!==n[s].z)){let i=Kn(e,n);Ie(i)}return A.releasePointerCapture(t.pointerId),It(),se(),I.IDLE}},[I.ROTATE]:{[O.POINTER_DOWN]:t=>to(t,I.ROTATE),[O.POINTER_MOVE]:t=>{if(!_)return I.ROTATE;let e={x:D.x-_.x,z:D.z-_.z},n=Math.atan2(e.z,e.x)-no,o=c.settings.rotationSnap>0?c.settings.rotationSnap:5,s=Math.round(n*(180/Math.PI)/o)*o*(Math.PI/180),r=Math.cos(s),a=Math.sin(s);return C.pointIds.forEach((l,d)=>{let p=Ue[d].x-_.x,u=Ue[d].z-_.z;c.points[l].position.x=_.x+(p*r-u*a),c.points[l].position.z=_.z+(p*a+u*r)}),cn(),I.ROTATE},[O.POINTER_UP]:t=>(It(),se(),I.ROTATE)},[I.SCALE]:{[O.POINTER_DOWN]:t=>to(t,I.SCALE),[O.POINTER_MOVE]:t=>{let e={x:D.x-_.x,z:D.z-_.z},n=1;return Bt>0&&(n=(e.x*dn.x+e.z*dn.z)/(Bt*Bt)),C.pointIds.forEach((o,i)=>{let s=Ue[i].x-_.x,r=Ue[i].y-_.y,a=Ue[i].z-_.z;c.points[o].position.x=me(_.x+s*n),c.points[o].position.y=me(_.y+r*n),c.points[o].position.z=me(_.z+a*n)}),cn(),I.SCALE},[O.POINTER_UP]:t=>(It(),se(),I.SCALE)},[I.ADD_POINT]:{[O.POINTER_DOWN]:t=>{if(t.button!==0)return I.ADD_POINT;let e=Yn();return Ie(e),I.ADD_POINT},[O.POINTER_MOVE]:t=>(io(),I.ADD_POINT),[O.POINTER_UP]:t=>I.ADD_POINT},[I.ADD_DOOR]:{[O.POINTER_MOVE]:t=>{if(T){let e=c.settings.gridSize;Le=ze.getClosestPointOnBranches(D,T,e),se()}return so(),I.ADD_DOOR},[O.POINTER_UP]:t=>{let e=Un(Le,it,st);return Ie(e),I.IDLE}},[I.PICK_POLYGON]:{[O.POINTER_DOWN]:t=>{let e=c.locations[ee];if(!e)return null;let n=ze.getSelectedPolygon(t);if(n){if(!e.polygonIds.includes(n))e.polygonIds.push(n);else{let o=e.polygonIds.indexOf(n);o!==-1&&e.polygonIds.splice(o,1)}return Fe(),I.PICK_POLYGON}}},[I.PICK_POINT]:{[O.POINTER_DOWN]:t=>{if(S.length===1){let e=S[0],n=c.points[e],o=ze.pickPoint(Rt);if(!o)return;if(n.locationId){let i=c.locations[ee];if(!i)return null;if(!i.accessPointIds.includes(o))i.accessPointIds.push(o);else{let s=i.accessPointIds.indexOf(o);s!==-1&&i.accessPointIds.splice(s,1)}Fe()}else{let i=c.points[o];n.twins=n.twins||[],i.twins=i.twins||[],n.twins.includes(o)||n.twins.push(o),i.twins.includes(e)||i.twins.push(e),Mt()}}return I.PICK_POINT}}})});function oi(t,e,n,o){let i=document.createElement("div");Object.assign(i.style,{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e4});let s=document.createElement("div");Object.assign(s.style,{background:t==="error"?"#ffe6e6":"#f0f8ff",color:t==="error"?"#900":"#000",padding:"20px",borderRadius:"8px",minWidth:"280px",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",textAlign:"center"});let r=document.createElement("p");r.textContent=e,r.style.margin="0 0 16px",s.appendChild(r);let a=document.createElement("button");a.textContent="OK",Object.assign(a.style,{padding:"8px 16px",border:"none",borderRadius:"4px",cursor:"pointer",background:t==="error"?"#d9534f":"#007bff",color:"#fff"}),a.addEventListener("click",()=>{document.body.removeChild(i),n?.()}),s.appendChild(a);let l=document.createElement("button");l.textContent="Cancel",Object.assign(l.style,{padding:"8px 16px",border:"none",borderRadius:"4px",cursor:"pointer",background:"#6c757d",color:"#fff",marginLeft:"8px"}),l.addEventListener("click",()=>{document.body.removeChild(i),o?.()}),s.appendChild(l),i.appendChild(s),document.body.appendChild(i)}function Dt(t,e,n){oi("info",t,e,n)}var un=N(()=>{});function ao(){he=new Image,document.getElementById("deleteLayer").addEventListener("click",r=>{let a=si();if(!a)return null;Dt("Are you sure you want to delete this layer?",()=>{ri(a.groupId,a.layerId),ye(),rt()},null)});let e=document.getElementById("layerName");e.style.marginBottom="8px";let n=document.getElementById("bgWidthInput");n.style.marginBottom="8px";let o=document.getElementById("bgHeightInput");o.style.marginBottom="8px";let i=document.getElementById("bgOpacityInput");i.style.marginBottom="8px";let s=document.getElementById("bgOpacityValue");document.querySelector(".side-menu").addEventListener("click",r=>{let a=r.target.closest(".btn-bg-assign");if(!a)return;let l=r.target.closest(".field-group");if(a){let d=l.querySelector(".bg-file-input");d.click(),d.onchange=()=>{let p=d.files[0];if(!p)return;let u=new FileReader;u.onload=()=>{let g=He();g&&(g.backgroundDataURI=u.result,g.backgroundFileName=p.name,typeof g.backgroundOpacity!="number"&&(g.backgroundOpacity=1,document.getElementById("bgOpacityInput").value="1"),rt())},u.readAsDataURL(p)}}}),e.addEventListener("input",r=>{let a=He();a&&(a.name=r.target.value,ye())}),n.addEventListener("input",r=>{let a=He();if(!a)return;let l=parseFloat(r.target.value);!isNaN(l)&&l>=0&&(a.backgroundWorldWidth=l,v())}),o.addEventListener("input",r=>{let a=He();if(!a)return;let l=parseFloat(r.target.value);!isNaN(l)&&l>=0&&(a.backgroundWorldHeight=l,v())}),i.addEventListener("input",r=>{let a=He();if(!a)return;let l=parseFloat(r.target.value);!isNaN(l)&&l>=0&&l<=1&&(a.backgroundOpacity=l,v())}),rt()}function rt(){let t=document.getElementById("layerName"),e=document.getElementById("bgWidthInput"),n=document.getElementById("bgHeightInput"),o=document.getElementById("bgOpacityInput"),i=document.getElementById("bgFileName"),s=He();s&&(t.value=s.name,e.value=s.backgroundWorldWidth??"",n.value=s.backgroundWorldHeight??"",o.value=s.backgroundOpacity,i.value=s.backgroundFileName||"",ii())}function ii(){let t=He();if(!t)return;let e=t.backgroundDataURI;he||(he=new Image),e?(he.src=e,he.onload=()=>{v()}):(he=null,v())}function He(){if(!y||y.length===0)return null;let t=y.at(-1),e=c.groups[t.groupId];if(!e)return null;let n=e.layers[t.layerId];return n||null}function si(){if(!y||y.length===0)return null;let t=y.at(-1);return t===-1?null:{groupId:t.groupId,layerId:t.layerId}}function ri(t,e){t&&c.groups[t]&&delete c.groups[t].layers[e],Object.keys(c.points).forEach(n=>{c.points[n].layerId===e&&delete c.points[n]}),Object.keys(c.locations).forEach(n=>{c.locations[n].layerId===e&&delete c.locations[n]}),ie(null),y.length=0}var he,gn=N(()=>{G();un();X();Pe();H()});function yo(t,e,n,o,i){Ve=t,we=e,W=n,R=o,Oe=i,Te=Ve.getContext("2d"),ae=we.getContext("2d"),f=W.getContext("2d"),P=R.getContext("2d"),B=Oe.getContext("2d"),document.readyState==="complete"?Ze():window.addEventListener("load",Ze,{once:!0}),Te.clearRect(0,0,Ve.width,Ve.height),ae.clearRect(0,0,we.width,we.height),B.clearRect(0,0,Oe.width,Oe.height),P.clearRect(0,0,R.width,R.height),window.addEventListener("resize",Ze);let s=new Image;s.src="/Images/Pin.png",ke.selectedLocation=s;let r=new Image;r.src="/Images/StandbyLocation.png",ke.standbyLocation=r;let a=new Image;a.src="/Images/Key.png",ke.accessPoint=a;let l=new Image;l.src="/Images/Portal.png",ke.portal=l;let d=window.devicePixelRatio||1,p=W.getBoundingClientRect(),u=p.width*d/2,g=p.height*d/2;te=Kt(W,{initialPan:{dx:u,dy:g},onUpdate:di})}function di(t){L=t.scale,U.x=t.dx,U.y=t.dy,bo(),xo(),ho(),Io()}function v(){if(!te)return;let t=te.getTransform();t&&(L=t.scale,U.x=t.dx,U.y=t.dy,bo(),xo(),ho(),Io())}function ho(){f.setTransform(1,0,0,1,0,0),f.clearRect(0,0,W.width,W.height),f.save(),f.setTransform(L,0,0,L,U.x,U.y),ui(),f.restore()}function Io(){B.setTransform(1,0,0,1,0,0),B.clearRect(0,0,Oe.width,Oe.height),Ne&&(B.save(),Ii(),B.restore())}function xo(){ae.setTransform(1,0,0,1,0,0),ae.clearRect(0,0,we.width,we.height),Ne&&(ae.save(),ae.setTransform(L,0,0,L,U.x,U.y),yi(),ae.restore())}function bo(){Te.setTransform(1,0,0,1,0,0),Te.clearRect(0,0,Ve.width,Ve.height),Te.save(),Te.setTransform(L,0,0,L,U.x,U.y),hi(),Te.restore()}function Z(){for(let n of Object.values(c.points))n&&(n.associatedLines=[]);let t=["none","innerwall","outerwall"],e=["floor","public","private"];for(let n of Object.values(c.groups))if(n){for(let o of Object.values(n.layers))if(o){o.linesByStyle={};for(let i of t)o.linesByStyle[i]=[];o.polygonsByStyle={};for(let i of e)o.polygonsByStyle[i]=[]}}for(let[n,o]of Object.entries(c.groups))if(o){for(let[i,s]of Object.entries(o.layers))if(s){for(let[r,a]of Object.entries(s.lines||{})){if(!a)continue;for(let d of a.pointIds){let p=c.points[d];p.groupId=n,p.layerId=i,p&&!p.isLocation&&p.associatedLines.push(r)}let l=s.linesByStyle[a.styleId];l&&l.push(r)}for(let[r,a]of Object.entries(s.polygons||{})){let l=s.polygonsByStyle[a.styleId];l&&l.push(r)}}}}function pi(){xt=new Map,y.forEach(t=>{if(!t.groupId)return;let e=c.groups[t.groupId];if(!t.layerId)return;let n=e.layers[t.layerId];Object.entries(n.lines??{}).forEach(([o,i])=>{i&&i.pointIds.forEach(s=>{c.points[s]&&Ei(s)})})})}function et(t){let e=null;return t&&(pi(),e=vi(t)),e}function ui(){c.groups&&(_e?gi():(f.save(),Object.entries(c.groups).forEach(([t,e])=>{Object.entries(e.layers).forEach(([n,o])=>{let i=c.styles?.floor;if(i&&!i.enabled)return;let s=o.polygonsByStyle?.floor;s&&s.forEach(r=>{let a=o.polygons[r];f.fillStyle=mo,f.beginPath(),a?.pointIds.forEach((l,d)=>{let p=c.points[l];p&&(d===0?f.moveTo(p.position.x,p.position.z):f.lineTo(p.position.x,p.position.z))}),f.closePath(),f.fill()})})}),f.restore(),y.forEach((t,e)=>{let n=c.groups[t.groupId];if(!n)return;let o=n.layers[t.layerId];o&&(e===y.length-1?(uo(o,!0),fi(o)):uo(o,!1))})))}function gi(){if(f.save(),Object.entries(c.groups).forEach(([o,i])=>{Object.entries(i.layers).forEach(([s,r])=>{let a=r.polygonsByStyle?.floor;a&&a.forEach(l=>{let d=r.polygons[l];f.fillStyle=mo,f.beginPath(),d.pointIds.forEach((p,u)=>{let g=c.points[p];u===0?f.moveTo(g.position.x,g.position.z):f.lineTo(g.position.x,g.position.z)}),f.closePath(),f.fill()})})}),f.restore(),!y||y.length===0)return;let t=y.at(-1),e=c.groups[t.groupId];if(!e)return;let n=e.layers[t.layerId];n&&(dt.forEach(o=>{if(o==="none")return;let i=n.polygonsByStyle?.[o];if(!i)return;let s=c.styles?.[o];s&&!s.enabled||(f.fillStyle=s.color,i.forEach(r=>{let a=n.polygons[r];a&&(f.beginPath(),a.pointIds.map(l=>c.points[l]).forEach((l,d)=>{let{x:p,z:u}=l.position;d===0?f.moveTo(p,u):f.lineTo(p,u)}),f.closePath(),f.fill())}))}),dt.forEach(o=>{if(o==="none")return;let i=n.linesByStyle?.[o];i&&i.forEach(s=>{let r=n.lines[s];if(!r)return;let a=c.styles?.[o];if(a&&!a.enabled)return;let l=r.pointIds.map(d=>c.points[d]);l&&l.length>=2&&(f.lineWidth=a.lineThickness/L,f.strokeStyle=a.color,f.beginPath(),f.moveTo(l[0].position.x,l[0].position.z),l.slice(1).forEach(d=>f.lineTo(d.position.x,d.position.z)),f.stroke())})}))}function fi(t){le===z.POINT&&(f.globalAlpha=1,t.locationIds.forEach(e=>{let n=c.locations[e];if(!n)return;let o=c.points[n.pointId];if(!o)return;let i=e===ee?ke.selectedLocation:ke.standbyLocation;if(!i||!i.complete)return;let s=e===ee?30:24;f.save(),f.translate(o.position.x,o.position.z),f.scale(1/L,1/L),f.drawImage(i,-s/2,-s/2,s,s),f.restore();let r=n.name??n.locationType;f.save(),f.translate(o.position.x,o.position.z),f.scale(1/L,1/L),f.font="20px Arial",f.textAlign="center",f.textBaseline="middle",f.fillStyle="#000",f.fillText(r,0,-30),f.restore(),e===ee&&n.accessPointIds.forEach(a=>{let l=c.points[a];if(!l)return;f.save(),f.translate(l.position.x+1,l.position.z),f.scale(1/L,1/L),f.drawImage(ke.accessPoint,-s/2,-s/2,s,s),f.restore(),f.fillStyle=go;let d=6/L;f.beginPath(),f.arc(l.position.x,l.position.z,d,0,Math.PI*2),f.fill()})}))}function uo(t,e){f.save();let n=le===z.POINT;e?f.globalAlpha=1:f.globalAlpha=.3;let o;dt.forEach(s=>{let r=t.polygonsByStyle?.[s];if(!r)return;let a=c.styles?.[s];a&&!a.enabled||r.forEach(l=>{let d=t.polygons[l];d&&(o=a.color,f.fillStyle=o,f.beginPath(),d.pointIds.map(p=>c.points[p]).forEach((p,u)=>{if(!p)return;let{x:g,z:m}=p.position;u===0?f.moveTo(g,m):f.lineTo(g,m)}),f.fill())})});let i=ci;Object.entries(t.lines??{}).forEach(([s,r])=>{if(!r)return;xi(t,s,r.pointIds);let a=r.pointIds.map(d=>c.points[d]);if(a.length>=2){f.strokeStyle=i,n&&r.styleId==="none"&&(f.strokeStyle=go),f.lineWidth=3/L,f.beginPath();for(let d=0;d<a.length-1;d++){let p=a[d].position,u=a[d+1].position;f.moveTo(p.x,p.z),f.lineTo(u.x,u.z),f.stroke()}}let l;l=li,r.pointIds.forEach(d=>{let p=c.points[d];if(!p)return;let u=Array.isArray(p.associatedLines)?p.associatedLines.length:0,g=4/L;if(f.fillStyle=u>1?fo:l,f.beginPath(),f.arc(p.position.x,p.position.z,g,0,Math.PI*2),f.fill(),e&&p.twins&&p.twins.length!==0){f.save(),f.translate(p.position.x,p.position.z-1),f.scale(1/L,1/L),f.drawImage(ke.portal,-At/2,-At/2,At,At),f.restore(),f.strokeStyle=ai,f.lineWidth=3/L,f.beginPath(),f.setLineDash([.2,.2]);for(let m=0;m<p.twins.length;m++){let h=p.twins[m],x=c.points[h];if(!x)continue;let b=p.position,w=x.position;f.moveTo(b.x,b.z),f.lineTo(w.x,w.z),f.stroke()}}if(f.setLineDash([]),Qe&&!p.locationId){let m=p.position.x,h=p.position.z;f.save(),f.translate(m,h),f.scale(1/L,1/L),f.beginPath(),f.font="20px Arial",f.textAlign="center",f.textBaseline="middle",f.fillStyle="#000",f.fillText(u.toString(),m/L,h/L-15),f.restore()}})}),e&&mi(t),f.restore()}function mi(t){let e=le===z.LINE,n=le===z.POINT,o=le===z.POLYGON;if(f.save(),k.forEach(i=>{let s=t.polygons[i];if(!s)return;f.globalAlpha=.4;let r;if(o)r=po;else if(e)r=po;else if(n&&ee){let a=c.locations[ee];a&&a.polygonIds.includes(i)&&(r=at,f.globalAlpha=.2)}f.fillStyle=r,f.beginPath(),s.pointIds.map(a=>c.points[a]).forEach((a,l)=>{if(!a)return;let{x:d,z:p}=a.position;l===0?f.moveTo(d,p):f.lineTo(d,p)}),f.fill()}),f.restore(),T.length&&e&&(f.save(),f.lineWidth=6/L,f.strokeStyle=at,T.forEach(i=>{let s=t.lines[i];if(!s)return;let r;e?(f.globalAlpha=1,r=co):o?(f.globalAlpha=.4,r=fn):n&&(r=fn,f.globalAlpha=.4),f.strokeStyle=r,f.beginPath();let a=c.points[s.pointIds[0]];if(a){f.moveTo(a.position.x,a.position.z);for(let l=1;l<s.pointIds.length;l++){let d=c.points[s.pointIds[l]];d&&f.lineTo(d.position.x,d.position.z)}f.stroke()}}),f.restore()),S.length&&n){f.save(),f.strokeStyle=at,f.lineWidth=2/L;let i=10/L,s;S.forEach(r=>{let a=c.points[r];if(a){if(n)f.globalAlpha=1,s=co;else if(e)f.globalAlpha=.4,lineCount>1?s=fo:s=fn;else if(o)return;f.fillStyle=s,f.beginPath(),f.arc(a.position.x,a.position.z,i,0,Math.PI*2),f.stroke()}}),f.restore()}}function yi(){if(!y||y.length===0)return;let t=y.at(-1),e=c.groups[t.groupId];if(!e)return;let n=e.layers[t.layerId];n&&(Ct={},lo=1,dt.forEach(o=>{let i=n.polygonsByStyle?.[o];i&&i.forEach(s=>{let r=n.polygons[s];if(!r)return;let a=lo++,l=a>>16&255,d=a>>8&255,p=a&255,u=`rgb(${l},${d},${p})`;Ct[u]=s,ae.beginPath(),r.pointIds.map(g=>c.points[g])?.forEach((g,m)=>{if(!g)return;let{x:h,z:x}=g.position;m===0?ae.moveTo(h,x):ae.lineTo(h,x)}),ae.closePath(),ae.fillStyle=u,ae.fill()})}))}function hi(){if(!y||y.length===0)return;let t=y.at(-1),e=c.groups[t.groupId];if(!e)return;let n=e.layers[t.layerId];if(n&&(Te.globalAlpha=n.backgroundOpacity,he&&he.complete&&he.naturalWidth>0&&n&&n.backgroundWorldWidth&&n.backgroundWorldHeight)){let o=n.backgroundWorldWidth,i=n.backgroundWorldHeight;Te.drawImage(he,-o/2,-i/2,o,i)}}function Ii(){let t=window.devicePixelRatio||1,e=Oe.width,n=Oe.height;B.setTransform(1,0,0,1,0,0),B.clearRect(0,0,e,n);let o=1/L,i=Math.floor(-U.x*o),s=Math.ceil((e-U.x)*o),r=Math.floor(-U.y*o),a=Math.ceil((n-U.y)*o);B.setTransform(L,0,0,L,U.x,U.y);let l=4,p=(L-l)/(6-l);p=Math.max(0,Math.min(.3,p));let u=1/L;B.lineWidth=1*u,B.strokeStyle=`rgba(140,140,140,${p})`;let g=Math.abs(c.settings.gridSize)||1,m=Math.floor(i/g)*g,h=Math.floor(r/g)*g;B.beginPath();for(let x=m;x<=s;x+=g)B.moveTo(x,r),B.lineTo(x,a);for(let x=h;x<=a;x+=g)B.moveTo(i,x),B.lineTo(s,x);B.stroke(),B.lineWidth=2*u,B.strokeStyle="rgba(0,0,0,0.5)",B.beginPath(),B.moveTo(0,r),B.lineTo(0,a),B.moveTo(i,0),B.lineTo(s,0),B.stroke()}function io(){if(S.length===0||!y||y.length===0)return;let t=y.at(-1),e=c.groups[t.groupId];if(!e||!e.layers[t.layerId])return;P.setTransform(1,0,0,1,0,0),P.clearRect(0,0,R.width,R.height),P.save(),P.setTransform(L,0,0,L,U.x,U.y);let o=c.points[S[0]],i=6/L;P.fillStyle=at,P.beginPath(),P.lineWidth=2/L,P.strokeStyle=at,P.moveTo(o.position.x,o.position.z);let s=et(D);s?P.lineTo(c.points[s].position.x,c.points[s].position.z):P.lineTo(D.x,D.z),P.stroke(),P.restore()}function so(){if(pn()===I.ADD_DOOR&&Le){if(!y||y.length===0)return;let t=y.at(-1),e=c.groups[t.groupId];if(!e)return;let n=e.layers[t.layerId];if(!n)return;let o=n.lines[Le.lineId];if(!o)return;P.setTransform(1,0,0,1,0,0),P.clearRect(0,0,R.width,R.height),P.save(),P.setTransform(L,0,0,L,U.x,U.y);let i=o.pointIds.map(s=>c.points[s]);if(i.length>1){let s={x:Le.x,z:Le.z},r=i[Le.segmentIndex].position,a=i[Le.segmentIndex+1].position,l=a.x-r.x,d=a.z-r.z,p=Math.hypot(l,d);p!==0?(l/=p,d/=p):(l=0,d=0);let u=c.settings.gridSize;if(Math.hypot(l*p,d*p)<u*2){it=null,st=null;return}let m=l*u,h=d*u;it={x:s.x+m,y:s.y,z:s.z+h},st={x:s.x-m,y:s.y,z:s.z-h};let x=6/L;P.fillStyle=at,P.beginPath(),P.arc(it.x,it.z,x,0,Math.PI*2),P.arc(st.x,st.z,x,0,Math.PI*2),P.fill()}}P.restore()}function ro(t){P.setTransform(1,0,0,1,0,0),P.clearRect(0,0,R.width,R.height),P.save();let e=window.devicePixelRatio||1;P.setTransform(e,0,0,e,0,0),P.strokeStyle="#00e069",P.lineWidth=2/e,P.setLineDash([4,4]),P.strokeRect(Math.min(t.x0,t.x1),Math.min(t.y0,t.y1),Math.abs(t.x1-t.x0),Math.abs(t.y1-t.y0)),P.setLineDash([]),P.restore()}function xi(t,e,n){if(pn()===I.ADD_POINT)return;let o=t.lines[e];if(o.pointIds=o.pointIds.filter(i=>c.points[i]?!0:(delete c.points[i],!1)),n.length===0){delete t.lines[e],console.log(`Orphan line ${e} deleted`);return}if(n.length===1){let i=n[0],s=c.points[i];s.associatedLines&&s.associatedLines.length===1&&!s.locationId&&(Bn(i),$("location"))}if(n.length===2&&n[0]===n[1]){delete t.lines[e],console.log(`Orphan line ${e} deleted`);return}}function Ze(){let e=W.parentElement.getBoundingClientRect(),n=e.width*(window.devicePixelRatio||1),o=e.height*(window.devicePixelRatio||1);[Ve,we,W,Oe,R].forEach(i=>{i.width=n,i.height=o,i.style.width=e.width+"px",i.style.height=e.height+"px"}),console.log("resizeAllCanvases"),v()}function bi(t,e){let n=Math.floor(t/c.settings.gridSize),o=Math.floor(e/c.settings.gridSize);return`${n},${o}`}function Ei(t){let e=c.points[t],n=bi(e.position.x,e.position.z);xt.has(n)||xt.set(n,[]),xt.get(n).push(t)}function vi(t){let e=Math.floor(t.x/c.settings.gridSize),n=Math.floor(t.z/c.settings.gridSize),o=null,i=Math.abs(c.settings.gridSize)>0?Math.abs(c.settings.gridSize):1,r=i*i;for(let a=e-1;a<=e+1;a++)for(let l=n-1;l<=n+1;l++){let d=xt.get(`${a},${l}`);if(d)for(let p of d){let u=c.points[p];if(!u)continue;let g=u.position.x-t.x,m=u.position.z-t.z,h=g*g+m*m;h<r&&(r=h,o=p)}}return o}function Dn(t=6){console.log("reset center view editor");let e=W.width,n=W.height,o=0,i=0,s=e/2-t*o,r=n/2-t*i;te.setTransform({scale:t,dx:s,dy:r,rotation:0}),v()}var Ve,we,W,R,Oe,te,At,xt,it,st,Te,ae,f,B,P,L,U,Ct,lo,co,go,ai,po,fn,li,ci,fo,at,mo,ke,X=N(()=>{ne();Ce();Lt();ce();G();gn();H();Pe();Je();Ve=null,we=null,W=null,R=null,Oe=null,te=null,At=24,xt=new Map,it={},st={},Te=null,ae=null,f=null,B=null,P=null,L=null,U={},Ct={},lo=0,co="rgb(237, 134, 18)",go="rgb(18, 237, 113)",ai="rgba(245, 161, 16, 1)",po="rgba(229, 193, 127, 1)",fn="#7F7F7F",li="#454545ff",ci="#a4a4a4ff",fo="rgb(246, 30, 195)",at="rgb(230, 44, 44)",mo="rgb(240, 240, 240)",ke={};window.addEventListener("IndoorLens:modeChange",t=>{t.detail.mode!=I.ADD_POINT&&(P.setTransform(1,0,0,1,0,0),P.clearRect(0,0,R.width,R.height))})});function Eo(t){c=new ut,c.id=t,To(),v()}function An(){Ne=!Ne}function jn(){_e=!_e}function _n(){Qe=!Qe}function Gn(){je=!je}function vo(t){c=new ut(t),console.log("MapModel :",c);let e=document.querySelector("#locationBadge span");e.textContent=c.name,To()}function So(t){c.settings.gridSize=t}function wo(t){c.settings.unit=t}function Po(t){c.settings.rotationSnap=t}function Lo(t){c.settings.selectionRadius=t}function To(){if(Ae(z.POINT),Ne=!0,je=!0,_e=!1,ie(null),y.length=0,Object.keys(c.groups).length===0)return;let t=Object.keys(c.groups)[0],e=c.groups[t];if(!e||Object.keys(e.layers).length===0)return;let n=Object.keys(e.layers)[0];De(!1),fe(t,n)}var c,Ne,je,_e,Qe,G=N(()=>{ne();X();H()});function Oo(){document.getElementById("deleteGroup").addEventListener("click",i=>{let s=Si();if(!s)return null;Dt("Are you sure you want to delete this group?",()=>{wi(s),ye(),Ye()},null)});let e=document.getElementById("groupName");e.style.marginBottom="8px",e.addEventListener("input",i=>{let s=jt();if(!s)return null;s.name=i.target.value,ye(),Ye()}),document.getElementById("groupType").addEventListener("change",i=>{let s=jt();if(!s)return null;s.type=i.target.value,ye(),Ye()});let o=document.getElementById("groupMetaInput");o.style.marginBottom="8px",o.addEventListener("input",i=>{let s=jt();if(!s)return null;s.meta=i.target.value,Ye()})}function Ye(){let t=jt();if(!t)return null;let e=document.getElementById("groupName");e.value=t.name;let n=document.getElementById("groupMetaInput");n.value=t.meta;let o=document.getElementById("groupType");o.value=t.type}function jt(){if(!y||y.length===0)return null;let t=y.at(-1),e=c.groups[t.groupId];return e||null}function Si(){if(!y||y.length===0)return null;let t=y.at(-1);return t===-1?null:t.groupId}function wi(t){t&&c.groups[t]&&delete c.groups[t],Object.keys(c.points).forEach(e=>{c.points[e].groupId===t&&delete c.points[e]}),Object.keys(c.locations).forEach(e=>{c.locations[e].groupId===t&&delete c.locations[e]}),ie(null),y.length=0}var Co=N(()=>{G();Pe();H();un()});function zo(){let t=document.getElementById("mapName");t.style.marginBottom="8px",t.addEventListener("input",r=>{if(!c)return;c.name=r.target.value;let a=document.querySelector("#locationBadge span");a.textContent=c.name,ye(),_t()});let e=document.getElementById("mapMetaInput");e.style.marginBottom="8px",e.addEventListener("input",r=>{c&&(c.meta=r.target.value,_t())});let n=document.getElementById("unitSelect");n.style.marginBottom="8px",Object.entries(pt).forEach(([r,a])=>{let l=document.createElement("option");l.value=a,l.textContent=r,n.appendChild(l)}),n.value=c.settings.unit||pt.Meters,n.addEventListener("change",r=>{n.value=r.target.value,c.referenceUnit=r.target.value,wo(r.target.value),v()});let o=document.getElementById("gridSizeInput");o.style.marginBottom="8px",o.addEventListener("input",r=>{o.value=r.target.value,So(r.target.value),v()});let i=document.getElementById("rotationSnapInput");i.style.marginBottom="8px",i.addEventListener("input",r=>{i.value=r.target.value,Po(r.target.value)});let s=document.getElementById("selectionRadiusInput");s.style.marginBottom="8px",s.addEventListener("input",r=>{s.value=r.target.value,Lo(r.target.value)}),Pi(),F(I.IDLE)}function _t(){if(!c)return;let t=document.getElementById("mapName");t.value=c.name;let e=document.getElementById("mapMetaInput");e.value=c.meta;let n=document.getElementById("unitSelect"),o=document.getElementById("gridSizeInput"),i=document.getElementById("rotationSnapInput"),s=document.getElementById("selectionRadiusInput");s.value=c.settings.selectionRadius,n.value=c.settings.unit,o.value=c.settings.gridSize,i.value=c.settings.rotationSnap,Gt()}function Pi(){c.settings.allowedDomains||(c.settings.allowedDomains=[]);let t=document.getElementById("allowed-domains-group");t.innerHTML="";let e=document.createElement("label");e.textContent="Allowed Domains:",e.className="secondary-title-label",e.style.marginRight="8px";let n=document.createElement("button");n.type="button",n.style.backgroundImage='url("/Images/Add.png")',n.style.backgroundSize="contain",n.style.backgroundRepeat="no-repeat",n.style.backgroundPosition="center",n.style.backgroundSize="14px 14px",n.style.width="20px",n.style.height="20px",n.className="toolbar-btn",n.addEventListener("click",()=>{c.settings.allowedDomains.push(""),Gt()});let o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-between",o.appendChild(e),o.appendChild(n),t.appendChild(o);let i=document.createElement("div");i.id="allowed-domains-list",i.style.marginTop="8px",t.appendChild(i),Gt()}function Gt(){let t=document.getElementById("allowed-domains-list");t.innerHTML="",c.settings.allowedDomains.forEach((e,n)=>{let o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.marginBottom="4px";let i=document.createElement("input");i.type="text",i.value=e,i.placeholder="example.com",i.className="form-control form-control-sm",i.style.flex="1",i.style.marginRight="2px",i.addEventListener("input",()=>{c.settings.allowedDomains[n]=i.value.trim()});let s=document.createElement("button");s.type="button",s.style.backgroundImage='url("/Images/Delete.png")',s.style.backgroundSize="contain",s.style.backgroundRepeat="no-repeat",s.style.backgroundPosition="center",s.style.backgroundSize="14px 14px",s.style.width="20px",s.style.height="20px",s.className="toolbar-btn ms-2",s.addEventListener("click",()=>{c.settings.allowedDomains.splice(n,1),Gt()}),o.appendChild(i),o.appendChild(s),t.appendChild(o)})}var No=N(()=>{Ce();G();X();Pe();ce()});function ko(t){let e=document.getElementById("embedDialog");if(!e){e=document.createElement("div"),e.id="embedDialog",Object.assign(e.style,{display:"none",position:"fixed",inset:"0",background:"rgba(0,0,0,0.5)",alignItems:"center",justifyContent:"center",zIndex:"9999",display:"flex"});let i=document.createElement("div");i.id="embedDialogContent",Object.assign(i.style,{background:"#fff",padding:"1.5rem",borderRadius:"0.5rem",maxWidth:"600px",width:"90%",maxHeight:"80%",overflowY:"auto",boxShadow:"0 4px 12px rgba(0,0,0,0.15)"}),i.innerHTML=`
      <h4 style="margin-top:0">Embed Code</h4>
      <pre>
        <code id="embedCode" class="language-html"></code>
      </pre>
      <div style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:1rem;">
        <button id="copyEmbedCode" style="
            padding:0.5rem 1rem;
            background:#0d6efd;
            color:#fff;
            border:none;
            border-radius:0.25rem;
            cursor:pointer;
          ">
          Copy Code
        </button>
        <button id="closeEmbedDialog" style="
            padding:0.5rem 1rem;
            background:#6c757d;
            color:#fff;
            border:none;
            border-radius:0.25rem;
            cursor:pointer;
          ">
          Close
        </button>
      </div>
    `,e.appendChild(i),document.body.appendChild(e),i.querySelector("#closeEmbedDialog").addEventListener("click",()=>e.style.display="none"),i.querySelector("#copyEmbedCode").addEventListener("click",()=>{let s=e.querySelector("#embedCode").textContent;navigator.clipboard.writeText(s).then(()=>{let r=e.querySelector("#copyEmbedCode");r.textContent="Copied!",setTimeout(()=>r.textContent="Copy Code",2e3)})})}let n=`
<div id="mapbootviewer"></div>
<script type="module">
  import { init } from '/js/editor/mapboot_viewer.js';
  init({
    target: '#mapbootviewer',
    mapid: '${t}',
    type: 'viewer'
  });
<\/script>
`,o=e.querySelector("#embedCode");o.textContent=n,window.hljs&&hljs.highlightElement(o),e.style.display="flex"}var Mo=N(()=>{(async function(){if(!window.hljs){let e=document.createElement("link");e.rel="stylesheet",e.href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css",document.head.appendChild(e),await new Promise((n,o)=>{let i=document.createElement("script");i.src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js",i.onload=n,i.onerror=o,document.head.appendChild(i)})}})()});function Bo(){Li(),Oi(),zo(),Oo(),ao(),$n(),$("map")}function Li(){let t=document.getElementById("navTree"),e=document.createElement("div");e.style.display="flex",e.style.gap="8px",e.style.marginBottom="3px";let n=document.createElement("button");n.className="btn btn-secondary toolbar-btn",n.style.backgroundImage="url('/Images/Back.png')",n.style.backgroundRepeat="no-repeat",n.style.backgroundPosition="center",n.style.backgroundSize="16px 16px",n.style.height="20px",n.style.fontSize="12px",n.title="Back",n.style.cursor="pointer";let o=document.createElement("button");o.textContent="Save",o.className="btn btn-secondary toolbar-btn",o.style.height="20px",o.style.fontSize="12px",o.style.flex="1",o.style.cursor="pointer";let i=document.createElement("button");i.textContent="Publish",i.className="btn btn-secondary toolbar-btn",i.style.height="20px",i.style.fontSize="12px",i.style.flex="1",i.style.cursor="pointer";let s=document.createElement("button");s.textContent="Embed",s.className="btn btn-secondary toolbar-btn",s.style.height="20px",s.style.fontSize="12px",s.style.flex="1",s.style.cursor="pointer",e.appendChild(n),e.appendChild(o),e.appendChild(i),e.appendChild(s),t&&t.parentElement&&t.parentElement.insertBefore(e,t),n.addEventListener("click",()=>{if($t&&confirm("You have unsaved changes. Save before leaving?")){o.click();return}window.location.href="/Dashboard/Index"}),o.addEventListener("click",()=>{let r=c.id,a=document.getElementById("loadingOverlay"),l=document.getElementById("deadOverlay");a?.classList.remove("hidden"),l?.classList.add("hidden"),xn({map:c,onSuccess:()=>{console.log("Successfully sent to cloud, map id:",r),De(!1),a?.classList.add("hidden")},onError:d=>{console.error(d),console.error("Could not save to cloud"),l?.classList.remove("hidden")}}).finally(()=>{a?.classList.add("hidden")})}),i.addEventListener("click",()=>{let r=c.id,a=document.getElementById("loadingOverlay"),l=document.getElementById("deadOverlay");a?.classList.remove("hidden"),l?.classList.add("hidden");let d=!1;bn({mapid:r,onSuccess:()=>{console.log("Successfully published, map id:",r),De(!1),a?.classList.add("hidden"),d=!0},onError:p=>{console.error(p),console.error("Could not publish map with id",r),l?.classList.remove("hidden"),d=!1}}).finally(()=>{a?.classList.add("hidden");let p=confirm("Map has been published successfully, would you like to view it?");d&&p&&(window.location.href="/Builder/Viewer?mapid="+r)})}),s.addEventListener("click",()=>{ko(c.id)})}function $(t){document.getElementById("menu").querySelectorAll(".content-panel").forEach(o=>{o.classList.toggle("hidden",o.dataset.content!==t)}),console.log("content is ",t),t=="map"?_t():t=="group"?Ye():t=="layer"?rt():t=="location"?Fe():t=="point"&&Mt(),Do(),v()}function Ti(t=document.getElementById("navTree")){t.querySelectorAll(".label.selected").forEach(e=>e.classList.remove("selected"))}function Oi(){let t=document.getElementById("navTree");Ft(),t.addEventListener("NavTree:select",e=>{let{key:n}=e.detail;console.log("user clicked point:",n)})}function ye(){Ft()}function Ft(){let t=document.getElementById("navTree");t.innerHTML="";let e=document.createElement("div");e.className="point",e.style.display="flex",e.style.alignItems="center",e.dataset.key="map",e.dataset.level="map";let n=document.createElement("span");n.className="label",n.textContent=c.name||c.id,n.style.color="#2aa14eff",n.style.fontSize="14px",n.style.paddingLeft="20px",n.style.cursor="pointer",n.addEventListener("click",r=>{r.stopPropagation(),$("map")}),e.appendChild(n),e.querySelector(".label").style.cursor="pointer",e.querySelector(".label").addEventListener("click",r=>{r.stopPropagation(),$("map")}),t.appendChild(e);let o=document.createElement("div");o.className="point",o.style.display="flex",o.style.alignItems="center",o.style.gap="4px",o.style.backgroundColor="rgba(200, 200, 200, 1)",t.appendChild(o);let i=document.createElement("button");i.className="btn-img",i.title="Add group",i.style.marginLeft="auto",i.style.paddingRight="5px",i.style.backgroundImage="url(/Images/AddGroup.png)",i.style.backgroundRepeat="no-repeat",i.style.backgroundPosition="center",i.style.backgroundSize="20px 20px",i.addEventListener("click",r=>{r.stopPropagation();let a=new Xe,l=K();c.groups[l]=a,y.length=0,fe(l,Object.keys(a.layers)[0]),Ye?.(),Ft(c,t)}),e.appendChild(i);let s=document.createElement("ul");t.appendChild(s),Object.entries(c.groups).forEach(([r,a])=>{let l=Ro(s,r,null,null,a,"group"),d=document.createElement("ul");l.appendChild(d),Object.entries(a.layers).forEach(([p,u])=>{let g=Ro(d,r,p,null,u,"layer")})}),Do()}function Ci(t,e){let n=t.querySelector(`.point[data-key="${e}"]`);if(!n)return;function o(s){let r=s.querySelector(".toggle");r&&r.textContent==="\u25B8"&&(r.textContent="\u25BE"),s.parentElement.querySelectorAll(":scope > ul").forEach(a=>a.style.display="")}o(n);let i=n.parentElement;for(;i;){let s=i.parentElement?.closest("li");if(!s)break;let r=s.querySelector(":scope > .point");r&&o(r),i=s}}function Ro(t,e,n,o,i,s=""){let r=document.createElement("li"),a=document.createElement("div");a.className="field-group  point",a.dataset.groupId=e,a.dataset.layerId=n,a.dataset.locationId=o,a.dataset.level=s,s==="group"?a.dataset.key=e:s==="layer"?a.dataset.key=n:s==="location"&&(a.dataset.key=o);let l=null;s==="group"&&(l=document.createElement("span"),l.className="toggle",l.textContent="\u25BE",a.appendChild(l));let d;if(s==="group"?(d=document.createElement("span"),d.style.fontSize="14px",d.className="label list-name",d.textContent=i.name??""):s==="layer"&&(d=document.createElement("span"),d.style.fontSize="12px",d.style.fontStyle="italic",d.className="label",d.textContent=i.name??""),a.appendChild(d),s==="group"){let u=document.createElement("button");u.className="btn-img",u.title="Add layer",u.style.paddingRight="5px",u.style.backgroundImage="url(/Images/AddLayer.png)",u.style.backgroundRepeat="no-repeat",u.style.backgroundPosition="center",u.style.backgroundSize="20px 20px",u.onclick=g=>{g.stopPropagation();let m=c.groups[e],h=new Ke,x=Object.keys(m.layers).length+1,b=K();m.layers[b]=h,fe(e,b),rt?.(),Ft(),Ci(document.getElementById("navTree"),e)},a.appendChild(u)}if(l){let u=!1;l.onclick=g=>{g.stopPropagation(),u=!u,l.textContent=u?"\u25BE":"\u25B8",r.querySelectorAll(":scope > ul").forEach(m=>m.style.display=u?"":"none")}}a.onclick=u=>{if(s==="group"){let g=c.groups[e];if(!g)return;let m=Object.keys(g.layers)[0];m?u.metaKey?fe(e,m):(y.length=0,fe(e,m)):u.metaKey?fe(e,null):(y.length=0,fe(e,null)),$("group")}else if(s==="layer"){let g=c.groups[e];if(!g||!g.layers[n])return;u.metaKey?fe(e,n):(y.length=0,fe(e,n)),$("layer")}},r.appendChild(a),t.appendChild(r);let p=null;return(s==="group"||s==="layer")&&(p=document.createElement("ul"),p.style.display="",r.appendChild(p)),p}function mn(t,e,n=document.getElementById("navTree")){let o=CSS.escape(t),i=e?`.point[data-level="${e}"][data-key="${o}"]`:`.point[data-key="${o}"]`;return n.querySelector(i)}function Do(){let t=document.getElementById("navTree");Ti(t),y.forEach(e=>{let n=mn(e.groupId)||mn(e.groupId,"group");if(n){let o=n.querySelector(".label");o&&o.classList.add("selected")}if(e.layerId){let o=mn(e.layerId,"layer");if(o){let i=o.querySelector(".label");i&&i.classList.add("selected")}}}),v()}var Pe=N(()=>{Co();gn();sn();rn();No();G();H();ne();X();Ut();Mo();if(!document.getElementById("tree-ui-style")){let t=document.createElement("style");t.id="tree-ui-style",t.textContent=`
  /* Highlight selected label text */
  #navTree .label.selected {
    color: #2aa14eff;
 
  }
  /* Zebra striping on li elements for group rows */
  #navTree > ul > li:nth-child(odd) { background: rgba(240, 240, 240, 0.8); }
 
  `,document.head.appendChild(t)}});var jo={};hn(jo,{buildIndoorLensDOM:()=>Ao,widget:()=>yn});function zi(){return new Promise((t,e)=>{if(document.getElementById("indoorlens-css"))return t();let n=document.createElement("link");n.id="indoorlens-css",n.rel="stylesheet",n.href="/dist/indoorlens-editor.css",n.onload=()=>t(),n.onerror=e,document.head.appendChild(n)})}function Ao(t){zi();let e=document.createElement("div");e.id="wrapper",e.className="ui-layout",e.style.display="flex",e.style.flexDirection="row",e.style.alignItems="stretch",e.style.width="100%",e.style.height="100%",t.appendChild(e),e.insertAdjacentHTML("beforeend",`
 
<!-- inside your existing side-menu element -->
<div  class="side-menu">
    <aside id="navTree" class="tree-panel"></aside> 

  <!-- 2) Content sections (only one visible at a time) -->
  <div id="menu" class="menu-content">

     

      <!-- \u2500\u2500\u2500 Map Panel \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 -->
    <div class="content-panel hidden" data-content="map">

      <div class="menu-header">
        <span class="secondary-title-label" >Map:</span> 
       </div>

             <div class="field-group">
          <label for="mapName">Name</label>
          <input
            type="text"
            id="mapName"
            placeholder="Map name here"
          />
        </div>

      <div class="field-group">
        <label for="mapMetaInput">MetaData:</label>
        <textarea
          id="mapMetaInput"
          rows="3"
          placeholder="Map meta here\u2026"
          style="width:100%; /* or whatever fits your layout */"
        ></textarea>
      </div>

                 <div class="menu-header">
        <span class="secondary-title-label" >Settings:</span>
      </div>
    <div class="field-group">
      <label for="unitSelect">Reference Unit:</label>
      <select id="unitSelect"></select>
    </div>
        <div class="field-group">
          <label for="gridSizeInput">Grid Size:</label>
          <input
            type="number"
            id="gridSizeInput"
            step="0.1"
            min="0"
            placeholder="e.g. 1"
          />
        </div>


          <div class="field-group">
          <label for="rotationSnapInput">Rotation Snap:</label>
          <input
            type="number"
            id="rotationSnapInput"
            step="1"
            min="0"
            placeholder="e.g. 15"
          />
        </div>

                <div class="field-group">
          <label for="selectionRadiusInput">Selection Radius:</label>
          <input
            type="number"
            id="selectionRadiusInput"
            step="1"
            min="1"
            placeholder="e.g. 5"
          />
        </div>

      <div id="allowed-domains-group"> </div>
    </div>



      <!-- \u2500\u2500\u2500 Group Panel \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 -->
    <div class="content-panel hidden" data-content="group">
   <div class="menu-header">
        <span class="secondary-title-label" >Group:</span> 
       <button id= "deleteGroup" class="btn-header " title="Delete Group">Delete</button>
    </div>

         <div class="field-group">
          <label for="groupName">Name</label>
          <input
            type="text"
            id="groupName"
            placeholder="Group name here"
          />
        </div>

      <div class="field-group">
        <label for="groupMetaInput">MetaData:</label>
        <textarea
          id="groupMetaInput"
          rows="3"
          placeholder="Group meta here\u2026"
          style="width:100%; /* or whatever fits your layout */"
        ></textarea>
      </div>

<!-- Group type selector -->
      <div class="field-group">
        <label for="groupType">Type:</label>
        <select id="groupType" name="layerType">
          <option value="regular">Regular</option>
          <option value="transit">Transit</option>
        </select>
    </div>
 
    </div>
 
    <!-- \u2500\u2500\u2500 Layers Panel \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 -->
    <div class="content-panel" data-content="layer">

       <div class="menu-header">
        <span class="secondary-title-label" >Layer:</span> 
        <button id= "deleteLayer" class="btn-header " title="Delete Layer">Delete</button>
     </div>

      <!-- 2b) Background Settings for Current Group -->
      <div class=" layer-settings">
              <div class="field-group">
          <label for="layerName">Name</label>
          <input
            type="text"
            id="layerName"
            placeholder="Layer name here"
          />
           
        </div>
        </div>

      <div class="menu-header">
        <span  class="secondary-title-label" >Blue Print:</span>
      </div>
        <!-- 1) Image chooser (file input) -->
<div class="field-group">
  <label for="bgFileName">Image:</label>

  <!-- new wrapper around the input+button -->
  <div class="bg-input-group">
    <input
      type="text"
      id="bgFileName"
      placeholder=""
      disabled
      style="border:none; outline:none; background:transparent; margin:0; padding:0;"
    />
         
    <button
      class="blueprint-btn btn-bg-assign"
      type="button"
      title="Assign background to layer"
      style="background-image:url('/Images/File.png')">
    </button>
  </div>

  <!-- keep the hidden file input here -->
  <input
    id="blueprint"
    class="bg-file-input"
    type="file"
    accept="image/*"
    hidden
  />
</div>

        <!-- 4) Opacity slider -->
        <div class="field-group">
          <label for="bgOpacityInput">Opacity:</label>
          <input
            type="range"
            id="bgOpacityInput"
            min="0"
            max="1"
            step="0.01"
            value="1"
          />
       
        </div>

        <!-- 2) Real-world Width input -->

 
        <div class="field-group">
          <label for="bgWidthInput">Width:</label>
          <input
            type="number"
            id="bgWidthInput"
            step="0.1"
            min="0"
            placeholder="e.g. 50"
          />
  
        </div>

              <div class="field-group">
          <label for="bgHeightInput">Height:</label>
     
            <input
            type="number"
            id="bgHeightInput"
            step="0.1"
            min="0"
            placeholder="e.g. 30"
          />
        </div>

      </div>
    <!-- \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 -->

    <!-- \u2500\u2500\u2500 Locations Panel \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 -->
    <div class="content-panel hidden" data-content="location">
        <div id="locationFieldsContainer"></div>
    </div>

        <!-- \u2500\u2500\u2500 Point Panel \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 -->
    <div class="content-panel hidden" data-content="point">
        <div id="pointContainer"></div>
    </div>


  </div>

  </div> 
 
    
  `);let n=document.createElement("div");n.className="canvases-container",e.appendChild(n);let o=document.createElement("canvas");o.id="canvasMain",o.className="canvas canvas-main",o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.zIndex="2",n.appendChild(o);let i=document.createElement("canvas");i.id="canvasBackground",i.className="canvas canvas-background",i.style.position="absolute",i.style.top="0",i.style.left="0",i.style.width="100%",i.style.height="100%",i.style.zIndex="0",n.appendChild(i);let s=document.createElement("canvas");s.id="canvasSelection",s.className="canvas canvas-selection",s.style.position="absolute",s.style.pointerEvents="none",s.style.opacity="0",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.zIndex="1",n.appendChild(s);let r=document.createElement("canvas");r.id="canvasOverlay",r.className="canvas canvas-overlay",r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.width="100%",r.style.height="100%",r.style.zIndex="3",n.appendChild(r);let a=document.createElement("canvas");a.id="canvasGrid",a.className="canvas canvas-grid",a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.style.zIndex="4",n.appendChild(a),n.insertAdjacentHTML("beforeend",`
    <div class="brand-badge badge">
      <img src="https://cdn.jsdelivr.net/gh/elseforty/IndoorLens/LocationIcons/IconDark.png" alt="MapBoot icon" />
      <span>MapBoot.com</span>
    </div>

    <div id="locationBadge" class="location-badge badge"  >
      <span></span>
      <img src="https://cdn.jsdelivr.net/gh/elseforty/IndoorLens/LocationIcons/LocationPin.png" alt="MapBoot location" />
    </div>
`),n.insertAdjacentHTML("beforeend",`
  
   <div class="search-bar" style="background: rgba(51, 51, 51, 0.3); padding:4px; border-radius:4px;">



         <button id=  "point" class="toolbar-btn"  alt="Point selection"  title="Point selection">
           <img src="/Images/Point.png" alt="Point selection" width="20" height="20">
      </button>
           <button id=  "edge" class="toolbar-btn"  title="Line selection">
           <img src="/Images/Line.png" alt="Line selection" width="20" height="20">
      </button>

     <button id=  "face" class="toolbar-btn" title="Polygon selection">
           <img src="/Images/Polygon.png" alt="Polygon selection"  width="20" height="20">
      </button>

 <div></div>
      <div></div>

    <button id= "addpoint" class="toolbar-btn" title="Add Point">
            <img src="/Images/Add.png" alt="add point" width="20" height="20">
      </button>


      <button id= "adddoor" class="toolbar-btn" title="Add Door On Selected Edge">
            <img src="/Images/Door.png" alt="Add door"  width="20" height="20">
      </button>
 

      <button id= "deletenode" class="toolbar-btn" title="Delete Point/Edge/Face">
            <img src="/Images/Delete.png" alt="delete point" width="20" height="20">
      </button>

      <div></div>
      <div></div>
   
 
      <button id= "rotate" class="toolbar-btn"  alt="Rotation"  title="Rotate Selection">
            <img src="/Images/Rotate.png" alt="Rotation" width="20" height="20">
      </button>

      <button id= "scale" class="toolbar-btn" title="Scale Selection">
            <img src="/Images/Scale.png" alt="Scale"  width="20" height="20">
      </button>

      <div></div>
      <div></div>
  

      <button id= "previewmode" class="toolbar-btn" title="Preview Map Graphics Mode"></button>
      <button id= "debugmode" class="toolbar-btn" title="Enable/Disable Debug Mode"></button>
      <button id= "grid" class="toolbar-btn" title="Show/Hide Grid"> </button>
      <button id= "snap" class="toolbar-btn" title="Snap Points"> </button>


      <div></div>
      <div></div>

      <button id= "centereditor" class="toolbar-btn" title="Center editor">
            <img src="https://cdn.jsdelivr.net/gh/elseforty/IndoorLens/LocationIcons/Center.png" alt="center" width="20" height="20">
      </button>
      <button id= "fullscreeneditor" class="toolbar-btn" title="Fullscreen editor">
            <img src="https://cdn.jsdelivr.net/gh/elseforty/IndoorLens/LocationIcons/Maximize.png" alt="fullscreen link"  width="20" height="20">
      </button>

      <div></div>
      <div></div>

      
      <div id="styletoolbar"> </div>
 
    </div>`),e.insertAdjacentHTML("beforeend",`
    <div id="loadingOverlay" class="loading-overlay hidden">
      <img src="https://cdn.jsdelivr.net/gh/elseforty/IndoorLens/LocationIcons/Loader.png" class="spin" alt="loading"/>
    </div>
    <div id="deadOverlay" class="loading-overlay hidden">
      <img src="https://cdn.jsdelivr.net/gh/elseforty/IndoorLens/LocationIcons/Dead.png" alt="dead"/>
    </div>`);let l=e.querySelector("#loadingOverlay"),d=e.querySelector("#deadOverlay");return{canvasBackground:i,canvasSelection:s,canvasMain:o,canvasOverlay:r,canvasGrid:a,loadingOverlay:l,deadOverlay:d}}var yn,_o=N(()=>{Ut();Pe();X();Je();G();en();yn=class{constructor(e,n){this.root=e,this.opts=n;let o=Ao(this.root);this.loadingOverlay=o.loadingOverlay,this.deadOverlay=o.deadOverlay;let i=n.mapid;if(console.log("Loading map with id:",i),i){let s=document.getElementById("loadingOverlay"),r=document.getElementById("deadOverlay");s?.classList.remove("hidden"),r?.classList.add("hidden"),In({mapid:i,onSuccess:a=>{vo(a),console.log("Successfully loaded, map id:",i),s?.classList.add("hidden")},onError:a=>{console.log("Could not load map, a new map is created",i),console.log("why ",a),Eo(i)}}).finally(()=>{r?.classList.add("hidden"),requestAnimationFrame(()=>{yo(o.canvasBackground,o.canvasSelection,o.canvasMain,o.canvasOverlay,o.canvasGrid),Fn(o.canvasMain,v),Bo(),Rn(),Z(),v(),s?.classList.add("hidden")})})}}}});var Ni={};hn(Ni,{init:()=>Go});function Go(t={}){let e=Object.assign({},t);window.mapboot=window.mapboot||{},window.mapboot.cfg={target:e.target};let n=typeof e.target=="string"?document.querySelector(e.target):e.target;if(!n)throw new Error("IndoorLens: target element not found");Promise.resolve().then(()=>(_o(),jo)).then(({widget:o})=>{window.mapboot=new o(n,e)})}typeof window<"u"&&(window.mapboot=window.mapboot||{},window.mapboot.init=Go);return Yo(Ni);})();
//# sourceMappingURL=mapboot.min.js.map
